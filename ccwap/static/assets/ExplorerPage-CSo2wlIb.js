import{u as xe,j as e}from"./query-vendor-ChV-W4bE.js";import{r as c,L as Ge}from"./react-vendor-yhu9f3WU.js";import{P as Fe}from"./PageLayout-CKQ82rM8.js";import{M as te,a as C}from"./MetricCardGrid-DAgrh55f.js";import{C as f}from"./ChartContainer-DT93XJhW.js";import{D as ke}from"./DataTable-CpCrRaw-.js";import{E as Ne}from"./EmptyState-DntujhHL.js";import{E as qe}from"./ErrorState-DjaCiOCU.js";import{C as se,a as ae,b as le,c as ne}from"./card-BPiuFm8S.js";import{h as pe,i as he,Y as me,u as Ve,B as U,a as Me,f as S,c as We,_ as Ye,$ as Qe,X as Ue,d as Xe,a0 as He,e as Ze}from"./index-Bpa7eUOS.js";import{S as Je}from"./skeleton-DdhmaHDM.js";import{S as oe,a as re,b as ie,c as ce,e as et,f as tt,d as W}from"./select-Do-LUKvn.js";import{f as Ce,C as n,T as b}from"./chartConfig-CHOlO3Nn.js";import{i as De,X as D,Y as T,T as y,j as Te,A as we,b as Ke,L as B,B as de,e as ue,P as st,f as at,C as lt,d as nt,k as ot,l as rt,m as it,n as ct,o as dt,p as ut}from"./chart-vendor-CnSh9PGG.js";import{C as xt}from"./chevron-down-CDKZgXf3.js";import"./table-Y6f_cB1E.js";import"./index-CW8GAOI9.js";import"./check-CQsps3zJ.js";function pt(s){return xe({queryKey:me.query(s),queryFn:()=>pe(`/explorer${he({metric:s.metric,group_by:s.group_by,split_by:s.split_by,from:s.from,to:s.to,projects:s.projects,models:s.models,branches:s.branches,languages:s.languages})}`),enabled:!!s.metric&&!!s.group_by})}function ht(s){return xe({queryKey:me.drilldown(s),queryFn:()=>pe(`/explorer/drilldown${he({metric:s.metric,group_by:s.group_by,group_value:s.group_value,split_by:s.split_by,split_value:s.split_value,from:s.from,to:s.to,projects:s.projects,models:s.models,branches:s.branches,languages:s.languages,page:s.page??1,limit:s.limit??25})}`),enabled:!!s.metric&&!!s.group_by&&!!s.group_value&&(!s.split_by||!!s.split_value)})}function mt(s,l){return xe({queryKey:me.filters(s,l),queryFn:()=>pe(`/explorer/filters${he({from:s,to:l})}`)})}const Le=[{value:"cost",label:"Cost ($)",group:"Turns"},{value:"input_tokens",label:"Input Tokens",group:"Turns"},{value:"output_tokens",label:"Output Tokens",group:"Turns"},{value:"cache_read_tokens",label:"Cache Read Tokens",group:"Turns"},{value:"cache_write_tokens",label:"Cache Write Tokens",group:"Turns"},{value:"ephemeral_5m_tokens",label:"Ephemeral 5m Tokens",group:"Turns"},{value:"ephemeral_1h_tokens",label:"Ephemeral 1h Tokens",group:"Turns"},{value:"thinking_chars",label:"Thinking Chars",group:"Turns"},{value:"turns_count",label:"Turns Count",group:"Turns"},{value:"loc_written",label:"LOC Written",group:"Tools"},{value:"tool_calls_count",label:"Tool Calls",group:"Tools"},{value:"errors",label:"Errors",group:"Tools"},{value:"lines_added",label:"Lines Added",group:"Tools"},{value:"lines_deleted",label:"Lines Deleted",group:"Tools"},{value:"sessions_count",label:"Sessions",group:"Sessions"},{value:"duration_seconds",label:"Duration (s)",group:"Sessions"}],$e=[{value:"date",label:"Date"},{value:"model",label:"Model"},{value:"project",label:"Project"},{value:"branch",label:"Branch"},{value:"language",label:"Language"},{value:"tool_name",label:"Tool Name"},{value:"cc_version",label:"CC Version"},{value:"entry_type",label:"Entry Type"},{value:"is_agent",label:"Agent/User"}],gt=new Set(["date","model","project","branch","cc_version","entry_type","is_agent"]),jt=new Set(["date","model","project","branch","language","tool_name","cc_version","entry_type","is_agent"]),ft=new Set(["date","project","branch","cc_version","is_agent"]),bt=new Set(["cost","input_tokens","output_tokens","cache_read_tokens","cache_write_tokens","ephemeral_5m_tokens","ephemeral_1h_tokens","thinking_chars","turns_count"]),yt=new Set(["loc_written","tool_calls_count","errors","lines_added","lines_deleted"]),_t=20;function vt(s){return s?bt.has(s)?gt:yt.has(s)?jt:ft:new Set}function Y(s,l){return l==="cost"?Me(s):l==="duration_seconds"?We(s):S(s)}function Q({label:s,options:l,selected:m,onChange:k}){const[$,w]=c.useState(!1),z=c.useCallback(i=>{k(m.includes(i)?m.filter(X=>X!==i):[...m,i])},[m,k]);return e.jsxs(Ye,{open:$,onOpenChange:w,children:[e.jsx(Qe,{asChild:!0,children:e.jsxs(U,{variant:"outline",role:"combobox","aria-expanded":$,className:Xe("w-full justify-between text-sm font-normal h-9",m.length>0&&"ring-1 ring-primary/30"),children:[e.jsx("span",{className:"truncate",children:m.length>0?`${s} (${m.length})`:s}),e.jsxs("div",{className:"flex items-center gap-1 shrink-0 ml-1",children:[m.length>0&&e.jsx(Ue,{className:"h-3 w-3 text-muted-foreground hover:text-foreground",onClick:i=>{i.stopPropagation(),k([])}}),e.jsx(xt,{className:"h-3.5 w-3.5 text-muted-foreground"})]})]})}),e.jsx(He,{className:"w-64 p-0",align:"start",children:e.jsx(Ze,{className:"max-h-60",children:e.jsx("div",{className:"p-1",children:l.length===0?e.jsx("p",{className:"px-3 py-2 text-xs text-muted-foreground",children:"No options"}):l.map(i=>e.jsxs("label",{className:"flex items-center gap-2 px-3 py-1.5 hover:bg-accent/50 cursor-pointer text-sm rounded-sm",children:[e.jsx("input",{type:"checkbox",checked:m.includes(i.value),onChange:()=>z(i.value),className:"rounded border-border"}),e.jsx("span",{className:"flex-1 truncate",children:i.label}),e.jsx("span",{className:"text-xs text-muted-foreground",children:i.count})]},i.value))})})})]})}function It(){const{dateRange:s}=Ve(),[l,m]=c.useState(null),[k,$]=c.useState(null),[w,z]=c.useState(null),[i,X]=c.useState([]),[O,Ee]=c.useState([]),[I,Re]=c.useState([]),[G,Ae]=c.useState([]),[g,ge]=c.useState(null),[F,q]=c.useState(1),K=vt(l),u=k&&K.has(k)?k:null,_=w&&K.has(w)&&w!==u?w:null,je={metric:l,group_by:u,split_by:_,from:s.from,to:s.to,projects:i.length?i.join(","):null,models:O.length?O.join(","):null,branches:I.length?I.join(","):null,languages:G.length?G.join(","):null},{data:d,isLoading:Pe,error:fe}=pt(je),{data:M}=mt(s.from,s.to),{data:L,isLoading:H,error:be}=ht({...je,group_value:g?.group??null,split_value:g?.split??null,page:F,limit:_t});c.useEffect(()=>{ge(null),q(1)},[l,u,_,s.from,s.to,i,O,I,G]);const N=u==="date",x=!!_,o=Le.find(t=>t.value===l)?.label??l??"",ye=c.useCallback((t,a)=>{ge({group:t,split:a}),q(1)},[]),{timeData:V,catData:Z,pieData:_e,treemapData:Be,radarData:J,splitKeys:E,tableRows:ve}=c.useMemo(()=>{if(!d||d.rows.length===0)return{timeData:[],catData:[],pieData:[],treemapData:[],radarData:[],splitKeys:[],tableRows:[]};const t=d.rows,a=d.metadata.splits;if(N&&x){const r=new Map;for(const h of t){r.has(h.group)||r.set(h.group,{date:h.group});const A=r.get(h.group);A[h.split??""]=h.value}return{timeData:Ce(Array.from(r.values()).sort((h,A)=>h.date.localeCompare(A.date)),a),catData:[],pieData:[],treemapData:[],radarData:[],splitKeys:a,tableRows:t}}if(N)return{timeData:[...t].map(p=>({date:p.group,value:p.value})).sort((p,h)=>p.date.localeCompare(h.date)),catData:[],pieData:[],treemapData:[],radarData:[],splitKeys:[],tableRows:t};if(x){const r=new Map;for(const j of t){r.has(j.group)||r.set(j.group,{name:j.group,total:0});const P=r.get(j.group);P[j.split??""]=j.value,P.total=(P.total||0)+j.value}const p=Ce(Array.from(r.values()).sort((j,P)=>P.total-j.total),a),h=p.slice(0,20),A=p.slice(0,8);return{timeData:[],catData:h,pieData:[],treemapData:[],radarData:A,splitKeys:a,tableRows:t}}const v=[...t].map(r=>({name:r.group,value:r.value})).sort((r,p)=>p.value-r.value),R=v.slice(0,20),ee=v.slice(0,10),Ie=v.slice(0,30).map((r,p)=>({...r,fill:n[p%n.length]}));return{timeData:[],catData:R,pieData:ee,treemapData:Ie,radarData:[],splitKeys:[],tableRows:t}},[d,N,x]),ze=c.useMemo(()=>{const t=[{accessorKey:"group",header:u??"Group",cell:({row:a})=>e.jsx("span",{children:a.original.group})}];return x&&t.push({accessorKey:"split",header:_??"Split",cell:({row:a})=>e.jsx("span",{children:a.original.split})}),t.push({accessorKey:"value",header:()=>e.jsx("span",{className:"text-right block",children:o}),cell:({row:a})=>e.jsx("span",{className:"font-mono text-right block",children:Y(a.original.value,l)})}),t.push({id:"actions",header:"",cell:({row:a})=>e.jsx("div",{className:"text-right",children:e.jsx(U,{size:"sm",variant:"outline",className:"h-7 px-2 text-xs",onClick:()=>ye(a.original.group,a.original.split??null),children:"Drill down"})})}),t},[u,_,x,o,l,ye]),Oe=c.useMemo(()=>[{accessorKey:"session_id",header:"Session",cell:({row:t})=>e.jsx(Ge,{to:`/sessions/${t.original.session_id}`,className:"font-mono text-xs text-primary hover:underline",children:t.original.session_id})},{accessorKey:"project",header:"Project",cell:({row:t})=>e.jsx("span",{className:"truncate block max-w-[220px]",children:t.original.project})},{accessorKey:"bucket_value",header:()=>e.jsx("span",{className:"text-right block",children:o}),cell:({row:t})=>e.jsx("span",{className:"font-mono text-right block",children:Y(t.original.bucket_value,l??"turns_count")})},{accessorKey:"total_cost",header:()=>e.jsx("span",{className:"text-right block",children:"Total Cost"}),cell:({row:t})=>e.jsx("span",{className:"font-mono text-right block",children:Me(t.original.total_cost)})},{accessorKey:"turns",header:()=>e.jsx("span",{className:"text-right block",children:"Turns"}),cell:({row:t})=>e.jsx("span",{className:"font-mono text-right block",children:S(t.original.turns)})},{accessorKey:"tool_calls",header:()=>e.jsx("span",{className:"text-right block",children:"Tools"}),cell:({row:t})=>e.jsx("span",{className:"font-mono text-right block",children:S(t.original.tool_calls)})},{accessorKey:"errors",header:()=>e.jsx("span",{className:"text-right block",children:"Errors"}),cell:({row:t})=>e.jsx("span",{className:"font-mono text-right block",children:S(t.original.errors)})}],[l,o]);return e.jsxs(Fe,{title:"Data Explorer",subtitle:"Query any metric by any dimension",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-3 mb-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-muted-foreground mb-1",children:"Metric"}),e.jsxs(oe,{value:l??"__none__",onValueChange:t=>{m(t==="__none__"?null:t),$(null),z(null)},children:[e.jsx(re,{children:e.jsx(ie,{placeholder:"Select metric..."})}),e.jsx(ce,{children:["Turns","Tools","Sessions"].map(t=>e.jsxs(et,{children:[e.jsx(tt,{children:t}),Le.filter(a=>a.group===t).map(a=>e.jsx(W,{value:a.value,children:a.label},a.value))]},t))})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-muted-foreground mb-1",children:"Group By"}),e.jsxs(oe,{value:u??"__none__",onValueChange:t=>$(t==="__none__"?null:t),disabled:!l,children:[e.jsx(re,{children:e.jsx(ie,{placeholder:"Select dimension..."})}),e.jsx(ce,{children:$e.map(t=>e.jsxs(W,{value:t.value,disabled:!K.has(t.value),children:[t.label,K.has(t.value)?"":" (N/A)"]},t.value))})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-muted-foreground mb-1",children:"Split By (optional)"}),e.jsxs(oe,{value:_??"__none__",onValueChange:t=>z(t==="__none__"?null:t),disabled:!l||!u,children:[e.jsx(re,{children:e.jsx(ie,{placeholder:"None"})}),e.jsxs(ce,{children:[e.jsx(W,{value:"__none__",children:"None"}),$e.filter(t=>t.value!==u).map(t=>e.jsxs(W,{value:t.value,disabled:!K.has(t.value),children:[t.label,K.has(t.value)?"":" (N/A)"]},t.value))]})]})]})]}),M&&e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-3 mb-6",children:[e.jsx(Q,{label:"Projects",options:M.projects,selected:i,onChange:X}),e.jsx(Q,{label:"Models",options:M.models,selected:O,onChange:Ee}),e.jsx(Q,{label:"Branches",options:M.branches,selected:I,onChange:Re}),e.jsx(Q,{label:"Languages",options:M.languages,selected:G,onChange:Ae})]}),!l||!u?e.jsx(Ne,{message:"Select a metric and dimension to explore"}):Pe?e.jsxs("div",{className:"space-y-4",children:[e.jsx(te,{skeleton:!0,count:4}),e.jsx(Je,{className:"h-80 w-full"})]}):fe?e.jsx(qe,{message:fe.message}):!d||d.rows.length===0?e.jsx(Ne,{message:"No data for current selection"}):e.jsxs(e.Fragment,{children:[e.jsxs(te,{className:"mb-6",children:[e.jsx(C,{title:"Total",value:Y(d.metadata.total,l)}),e.jsx(C,{title:"Data Points",value:S(d.metadata.row_count)}),e.jsx(C,{title:"Groups",value:S(d.metadata.groups.length)}),e.jsx(C,{title:x?"Splits":"Avg per Group",value:x?S(d.metadata.splits.length):Y(d.metadata.total/Math.max(d.metadata.groups.length,1),l)})]}),N&&!x&&e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-4 mb-6",children:[e.jsx(f,{title:`${o} Over Time`,height:320,children:e.jsxs(De,{data:V,children:[e.jsx(D,{dataKey:"date",tick:{fontSize:10}}),e.jsx(T,{tick:{fontSize:10}}),e.jsx(y,{contentStyle:b}),e.jsx(Te,{type:"monotone",dataKey:"value",stroke:n[0],strokeWidth:2,dot:{r:3},name:o})]})}),e.jsx(f,{title:`${o} Over Time`,height:320,children:e.jsxs(we,{data:V,children:[e.jsx("defs",{children:e.jsxs("linearGradient",{id:"explorerGrad",x1:"0",y1:"0",x2:"0",y2:"1",children:[e.jsx("stop",{offset:"5%",stopColor:n[0],stopOpacity:.3}),e.jsx("stop",{offset:"95%",stopColor:n[0],stopOpacity:0})]})}),e.jsx(D,{dataKey:"date",tick:{fontSize:10}}),e.jsx(T,{tick:{fontSize:10}}),e.jsx(y,{contentStyle:b}),e.jsx(Ke,{type:"monotone",dataKey:"value",stroke:n[0],fill:"url(#explorerGrad)",name:o})]})})]}),N&&x&&e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-4 mb-6",children:[e.jsx(f,{title:`${o} by ${_}`,height:320,children:e.jsxs(De,{data:V,children:[e.jsx(D,{dataKey:"date",tick:{fontSize:10}}),e.jsx(T,{tick:{fontSize:10}}),e.jsx(y,{contentStyle:b}),e.jsx(B,{}),E.map((t,a)=>e.jsx(Te,{type:"monotone",dataKey:t,stroke:n[a%n.length],strokeWidth:2,dot:!1,name:t},t))]})}),e.jsx(f,{title:`${o} Stacked`,height:320,children:e.jsxs(we,{data:V,children:[e.jsx(D,{dataKey:"date",tick:{fontSize:10}}),e.jsx(T,{tick:{fontSize:10}}),e.jsx(y,{contentStyle:b}),e.jsx(B,{}),E.map((t,a)=>e.jsx(Ke,{type:"monotone",dataKey:t,stackId:"1",stroke:n[a%n.length],fill:n[a%n.length],fillOpacity:.4,name:t},t))]})})]}),!N&&!x&&e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-4 mb-6",children:[e.jsx(f,{title:`${o} by ${u}`,height:320,children:e.jsxs(de,{data:Z,layout:"vertical",children:[e.jsx(D,{type:"number",tick:{fontSize:10}}),e.jsx(T,{dataKey:"name",type:"category",width:100,tick:{fontSize:10}}),e.jsx(y,{contentStyle:b}),e.jsx(ue,{dataKey:"value",fill:n[0],radius:[0,4,4,0],name:o})]})}),e.jsx(f,{title:`${o} Distribution`,height:320,children:e.jsxs(st,{children:[e.jsx(at,{data:_e,dataKey:"value",nameKey:"name",cx:"50%",cy:"50%",innerRadius:60,outerRadius:100,paddingAngle:2,label:({name:t,percent:a})=>`${t} ${(a*100).toFixed(0)}%`,labelLine:{strokeWidth:1},children:_e.map((t,a)=>e.jsx(lt,{fill:n[a%n.length]},a))}),e.jsx(y,{contentStyle:b})]})}),e.jsxs(se,{children:[e.jsxs(ae,{className:"pb-3 pt-4 px-4",children:[e.jsxs(le,{className:"text-sm font-medium text-muted-foreground",children:[o," Treemap"]}),e.jsx("span",{className:"text-xs text-muted-foreground",children:"Top 30 by size"})]}),e.jsx(ne,{className:"px-4 pb-4",children:e.jsx("div",{className:"h-80",children:e.jsx(nt,{width:"100%",height:"100%",children:e.jsx(ot,{data:Be,dataKey:"value",nameKey:"name",stroke:"var(--color-border)",content:({x:t,y:a,width:v,height:R,name:ee,fill:Se})=>e.jsxs("g",{children:[e.jsx("rect",{x:t,y:a,width:v,height:R,fill:Se,rx:2}),v>=30&&R>=20&&e.jsx("text",{x:t+v/2,y:a+R/2,textAnchor:"middle",dominantBaseline:"middle",fill:"white",fontSize:10,children:String(ee??"").slice(0,Math.floor(v/7))})]})})})})})]})]}),!N&&x&&e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-4 mb-6",children:[e.jsx(f,{title:`${o} Grouped`,height:320,children:e.jsxs(de,{data:Z,children:[e.jsx(D,{dataKey:"name",tick:{fontSize:10},angle:-30,textAnchor:"end",height:60}),e.jsx(T,{tick:{fontSize:10}}),e.jsx(y,{contentStyle:b}),e.jsx(B,{}),E.map((t,a)=>e.jsx(ue,{dataKey:t,fill:n[a%n.length],radius:[4,4,0,0],name:t},t))]})}),e.jsx(f,{title:`${o} Stacked`,height:320,children:e.jsxs(de,{data:Z,children:[e.jsx(D,{dataKey:"name",tick:{fontSize:10},angle:-30,textAnchor:"end",height:60}),e.jsx(T,{tick:{fontSize:10}}),e.jsx(y,{contentStyle:b}),e.jsx(B,{}),E.map((t,a)=>e.jsx(ue,{dataKey:t,stackId:"stack",fill:n[a%n.length],name:t},t))]})}),J.length>0&&J.length<=8&&e.jsx(f,{title:`${o} Radar`,height:320,children:e.jsxs(rt,{data:J,children:[e.jsx(it,{}),e.jsx(ct,{dataKey:"name",tick:{fontSize:10}}),e.jsx(dt,{tick:{fontSize:9}}),E.map((t,a)=>e.jsx(ut,{dataKey:t,stroke:n[a%n.length],fill:n[a%n.length],fillOpacity:.2,name:t},t)),e.jsx(B,{}),e.jsx(y,{contentStyle:b})]})})]}),e.jsxs(se,{children:[e.jsxs(ae,{className:"pb-3 pt-4 px-4",children:[e.jsx(le,{className:"text-sm font-medium text-muted-foreground",children:"Raw Data"}),e.jsxs("span",{className:"text-xs text-muted-foreground",children:[ve.length," rows (max 100 shown)"]})]}),e.jsx(ne,{className:"px-4 pb-4",children:e.jsx(ke,{columns:ze,data:ve.slice(0,100),emptyMessage:"No data"})})]}),e.jsxs(se,{className:"mt-6",children:[e.jsxs(ae,{className:"pb-3 pt-4 px-4",children:[e.jsx(le,{className:"text-sm font-medium text-muted-foreground",children:"Session Drill-down"}),e.jsx("span",{className:"text-xs text-muted-foreground",children:g?`${u}: ${g.group}${x?` | ${_}: ${g.split??"N/A"}`:""}`:"Select a row in Raw Data and click Drill down"})]}),e.jsx(ne,{className:"px-4 pb-4 space-y-3",children:g?be?e.jsx("p",{className:"text-sm text-destructive",children:be.message}):e.jsxs(e.Fragment,{children:[e.jsxs(te,{className:"lg:grid-cols-3",children:[e.jsx(C,{title:"Matching Sessions",value:S(L?.pagination.total_count??0)}),e.jsx(C,{title:"Page",value:`${L?.pagination.page??F} / ${Math.max(L?.pagination.total_pages??1,1)}`}),e.jsx(C,{title:"Bucket",value:g.split?`${g.group} / ${g.split}`:g.group})]}),e.jsx(ke,{columns:Oe,data:L?.sessions??[],isLoading:H,emptyMessage:"No sessions for this bucket"}),e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsx(U,{variant:"outline",size:"sm",onClick:()=>q(t=>Math.max(1,t-1)),disabled:H||F<=1,children:"Previous"}),e.jsx(U,{variant:"outline",size:"sm",onClick:()=>q(t=>t+1),disabled:H||!L||F>=(L.pagination.total_pages||1),children:"Next"})]})]}):e.jsx("p",{className:"text-sm text-muted-foreground",children:"No bucket selected."})})]})]})]})}export{It as default};
