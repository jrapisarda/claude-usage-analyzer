import{u as w,b as $,c as I,j as e}from"./query-vendor-ChV-W4bE.js";import{r as u,L as V}from"./react-vendor-yhu9f3WU.js";import{P as G}from"./PageLayout-DPasqS-O.js";import{m as J,n as p,h as j,i as L,u as K,B as E,b as H,d as Q,X as W,f as Z,a as ee}from"./index-nDEx28AN.js";import{u as se}from"./projects-J8akyil1.js";import{E as P}from"./ErrorState-C7Oppa98.js";import{E as U}from"./EmptyState-C9M8yoIu.js";import{C as q}from"./ChartContainer-B3BCIAzK.js";import{D as te}from"./DataTable-CGiFMBH3.js";import{C as v,a as C,b as T,c as S}from"./card-Byyeu849.js";import{I as R}from"./input-DaS1y_xR.js";import{B as ae}from"./badge-DqpYExzj.js";import{S as k}from"./skeleton-CAkgKQJz.js";import{T as re,a as ne,b as B,c as f,d as oe,e as b}from"./table-h59HnL4K.js";import{T as A,C as h}from"./chartConfig-CHOlO3Nn.js";import{P as ie,T as le}from"./trash-2-CcWs7elc.js";import{C as ce}from"./chevron-up-BTFuPs39.js";import{C as de}from"./chevron-down-BTehNVLo.js";import{B as me,X as ue,Y as xe,T as z,L as O,e as ge,l as he,m as pe,n as je,o as fe,p as be}from"./chart-vendor-CnSh9PGG.js";const _e=[["path",{d:"m16 3 4 4-4 4",key:"1x1c3m"}],["path",{d:"M20 7H4",key:"zbl0bi"}],["path",{d:"m8 21-4-4 4-4",key:"h9nckh"}],["path",{d:"M4 17h16",key:"g4d7ey"}]],ye=J("arrow-right-left",_e);function M(){return w({queryKey:p.tags,queryFn:()=>j("/experiments/tags")})}function Ne(t,a){return w({queryKey:p.compare(t,a),queryFn:()=>j(`/experiments/compare${L({tag_a:t,tag_b:a})}`),enabled:!!t&&!!a})}function ve(){const t=$();return I({mutationFn:a=>j("/experiments/tags",{method:"POST",body:JSON.stringify(a)}),onSuccess:()=>t.invalidateQueries({queryKey:p.tags})})}function Ce(){const t=$();return I({mutationFn:a=>j(`/experiments/tags/${encodeURIComponent(a)}`,{method:"DELETE"}),onSuccess:()=>t.invalidateQueries({queryKey:p.tags})})}function Te(t,a){return w({queryKey:p.compareMulti(t),queryFn:()=>j(`/experiments/compare-multi${L({tags:t.join(","),from:a.from,to:a.to})}`),enabled:t.length>=2})}function Se(t,a){return w({queryKey:p.tagSessions(t),queryFn:()=>j(`/experiments/tags/${encodeURIComponent(t)}/sessions${L({from:a.from,to:a.to})}`),enabled:!!t})}const ke=[{accessorKey:"session_id",header:"Session",cell:({row:t})=>e.jsxs(V,{to:`/sessions/${t.original.session_id}`,className:"font-mono text-xs text-primary hover:underline",children:[t.original.session_id.slice(0,8),"..."]})},{accessorKey:"project_display",header:"Project",cell:({row:t})=>e.jsx("span",{className:"text-muted-foreground truncate max-w-[150px] block text-xs",children:t.original.project_display})},{accessorKey:"start_time",header:"Started",cell:({row:t})=>e.jsx("span",{className:"text-muted-foreground text-xs",children:t.original.start_time?.slice(0,16)||"N/A"})},{accessorKey:"total_cost",header:()=>e.jsx("span",{className:"text-right block",children:"Cost"}),cell:({row:t})=>e.jsx("span",{className:"font-mono text-xs text-right block",children:ee(t.original.total_cost)})},{accessorKey:"turn_count",header:()=>e.jsx("span",{className:"text-right block",children:"Turns"}),cell:({row:t})=>e.jsx("span",{className:"text-xs text-right block",children:t.original.turn_count})},{accessorKey:"model_default",header:"Model",cell:({row:t})=>e.jsx("span",{className:"text-muted-foreground text-xs",children:t.original.model_default})}];function we({onTagClick:t,expandedTag:a}){const{dateRange:d}=K(),{data:i,isLoading:l,error:s,refetch:o}=M(),m=ve(),g=Ce(),[c,r]=u.useState(""),[x,_]=u.useState(""),[y,D]=u.useState(""),[N,F]=u.useState(""),{data:X}=se(d,"cost","desc",1,void 0),Y=u.useCallback(()=>{if(!c.trim())return;const n={tag_name:c.trim(),...x&&{date_from:x},...y&&{date_to:y},...N&&{project_path:N}};m.mutate(n,{onSuccess:()=>{r(""),_(""),D(""),F("")}})},[c,x,y,N,m]);return l?e.jsxs(v,{children:[e.jsx(C,{children:e.jsx(T,{className:"text-sm",children:"Tags"})}),e.jsxs(S,{children:[e.jsx(k,{className:"h-10 w-full mb-4"}),e.jsx(k,{className:"h-20 w-full"})]})]}):s?e.jsx(P,{message:s.message,onRetry:()=>o()}):e.jsxs(v,{children:[e.jsx(C,{children:e.jsx(T,{className:"text-sm",children:"Tags"})}),e.jsxs(S,{children:[e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-2 mb-4",children:[e.jsx(R,{type:"text",value:c,onChange:n=>r(n.target.value),placeholder:"Tag name..."}),e.jsx(R,{type:"date",value:x,onChange:n=>_(n.target.value)}),e.jsx(R,{type:"date",value:y,onChange:n=>D(n.target.value)}),e.jsxs("select",{value:N,onChange:n=>F(n.target.value),className:"flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring",children:[e.jsx("option",{value:"",children:"All Projects"}),X?.projects.map(n=>e.jsx("option",{value:n.project_path,children:n.project_display},n.project_path))]}),e.jsxs(E,{onClick:Y,disabled:!c.trim()||m.isPending,size:"sm",className:"h-9",children:[e.jsx(ie,{className:"mr-1 h-4 w-4"}),"Create"]})]}),!i||i.tags.length===0?e.jsx(U,{message:"No experiment tags"}):e.jsx("div",{className:"space-y-1",children:i.tags.map(n=>e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between py-2 px-3 rounded hover:bg-accent/10",children:[e.jsxs("button",{onClick:()=>t(n.tag_name),className:"flex items-center gap-3 text-left",children:[a===n.tag_name?e.jsx(ce,{className:"h-3 w-3 text-muted-foreground"}):e.jsx(de,{className:"h-3 w-3 text-muted-foreground"}),e.jsx("span",{className:"font-medium text-sm",children:n.tag_name}),e.jsxs(ae,{variant:"secondary",children:[n.session_count," sessions"]}),n.created_at&&e.jsx("span",{className:"text-xs text-muted-foreground",children:n.created_at})]}),e.jsx(E,{variant:"ghost",size:"icon",onClick:()=>g.mutate(n.tag_name),disabled:g.isPending,className:"text-muted-foreground hover:text-destructive",children:e.jsx(le,{className:"h-4 w-4"})})]}),a===n.tag_name&&e.jsx(Pe,{tagName:n.tag_name})]},n.tag_name))})]})]})}function Pe({tagName:t}){const{dateRange:a}=K(),{data:d,isLoading:i,error:l,refetch:s}=Se(t,a);if(l)return e.jsx("div",{className:"px-6 py-2",children:e.jsx(P,{message:l.message,onRetry:()=>s()})});const o=d?.sessions??[];return e.jsx("div",{className:"ml-6 mr-3 mb-2",children:e.jsx(te,{columns:ke,data:o,isLoading:i,emptyMessage:"No sessions for this tag"})})}function Re({tags:t,selectedTags:a,onToggle:d}){return e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"Select tags (up to 4):"}),t.map(i=>{const l=a.includes(i.tag_name),s=!l&&a.length>=4;return e.jsxs("button",{onClick:()=>d(i.tag_name),disabled:s,className:Q("inline-flex items-center gap-1 px-2.5 py-1 rounded-full text-xs font-medium transition-colors",l?"bg-primary text-primary-foreground":"bg-muted text-muted-foreground hover:bg-accent hover:text-foreground",s&&"opacity-40 cursor-not-allowed"),children:[i.tag_name," (",i.session_count,")",l&&e.jsx(W,{className:"h-3 w-3"})]},i.tag_name)})]})}function Le({tags:t}){const a=["sessions","cost","loc","turns","error_rate"],d=u.useMemo(()=>a.map(s=>{const o={metric:s};for(const m of t)o[m.tag_name]=m[s];return o}),[t]),i=u.useMemo(()=>a.map(s=>{const o=t.map(c=>c[s]),m=Math.max(...o,.001),g={metric:s};for(const c of t)g[c.tag_name]=s==="error_rate"?(1-c[s])*100:c[s]/m*100;return g}),[t]),l={sessions:"Sessions",cost:"Cost ($)",loc:"LOC",turns:"Turns",error_rate:"Error Rate"};return e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsx(q,{title:"Metric Comparison",height:288,children:e.jsxs(me,{data:d,margin:{top:4,right:8,left:0,bottom:4},children:[e.jsx(ue,{dataKey:"metric",tick:{fontSize:10},stroke:"var(--color-muted-foreground)",tickFormatter:s=>l[s]||s}),e.jsx(xe,{tick:{fontSize:10},stroke:"var(--color-muted-foreground)",width:55}),e.jsx(z,{contentStyle:A,formatter:(s,o)=>typeof s=="number"?[s<1?H(s):Z(s),o]:[s,o],labelFormatter:s=>l[s]||s}),e.jsx(O,{wrapperStyle:{fontSize:11}}),t.map((s,o)=>e.jsx(ge,{dataKey:s.tag_name,fill:h[o%h.length],radius:[4,4,0,0]},s.tag_name))]})}),e.jsx(q,{title:"Normalized Radar View",height:288,children:e.jsxs(he,{data:i,cx:"50%",cy:"50%",outerRadius:"70%",children:[e.jsx(pe,{stroke:"var(--color-border)"}),e.jsx(je,{dataKey:"metric",tick:{fontSize:10,fill:"var(--color-muted-foreground)"},tickFormatter:s=>l[s]||s}),e.jsx(fe,{tick:{fontSize:9},domain:[0,100]}),t.map((s,o)=>e.jsx(be,{name:s.tag_name,dataKey:s.tag_name,stroke:h[o%h.length],fill:h[o%h.length],fillOpacity:.15},s.tag_name)),e.jsx(O,{wrapperStyle:{fontSize:11}}),e.jsx(z,{contentStyle:A,formatter:(s,o)=>[`${Number(s).toFixed(1)}%`,o]})]})})]})}function Ke(){const{dateRange:t}=K(),{data:a}=M(),[d,i]=u.useState([]),{data:l,isLoading:s,error:o,refetch:m}=Te(d,t),g=a?.tags||[],c=u.useCallback(r=>{i(x=>x.includes(r)?x.filter(_=>_!==r):x.length<4?[...x,r]:x)},[]);return e.jsxs(v,{children:[e.jsx(C,{children:e.jsx(T,{className:"text-sm",children:"Multi-Tag Comparison"})}),e.jsxs(S,{children:[e.jsx("div",{className:"mb-4",children:e.jsx(Re,{tags:g,selectedTags:d,onToggle:c})}),d.length<2&&e.jsx("p",{className:"text-sm text-muted-foreground",children:"Select at least 2 tags to compare."}),s&&e.jsx(k,{className:"h-64 w-full"}),o&&e.jsx(P,{message:o.message,onRetry:()=>m()}),l&&l.tags.length>=2&&e.jsx(Le,{tags:l.tags})]})]})}function Me(){const{data:t}=M(),[a,d]=u.useState(""),[i,l]=u.useState(""),{data:s,isLoading:o,error:m,refetch:g}=Ne(a,i),c=t?.tags||[];return e.jsxs(v,{children:[e.jsx(C,{children:e.jsx(T,{className:"text-sm",children:"Compare Tags (A vs B)"})}),e.jsxs(S,{children:[e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsxs("select",{value:a,onChange:r=>d(r.target.value),className:"flex-1 h-9 rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring",children:[e.jsx("option",{value:"",children:"Select Tag A..."}),c.map(r=>e.jsxs("option",{value:r.tag_name,children:[r.tag_name," (",r.session_count,")"]},r.tag_name))]}),e.jsx(ye,{className:"h-4 w-4 text-muted-foreground shrink-0"}),e.jsxs("select",{value:i,onChange:r=>l(r.target.value),className:"flex-1 h-9 rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring",children:[e.jsx("option",{value:"",children:"Select Tag B..."}),c.map(r=>e.jsxs("option",{value:r.tag_name,children:[r.tag_name," (",r.session_count,")"]},r.tag_name))]})]}),o&&e.jsx(k,{className:"h-32 w-full"}),m&&e.jsx(P,{message:m.message,onRetry:()=>g()}),s&&e.jsxs("div",{children:[e.jsxs("div",{className:"flex gap-4 mb-4 text-sm",children:[e.jsxs("span",{children:[e.jsx("strong",{children:s.tag_a}),": ",s.tag_a_sessions," sessions"]}),e.jsxs("span",{children:[e.jsx("strong",{children:s.tag_b}),": ",s.tag_b_sessions," sessions"]})]}),s.metrics.length===0?e.jsx(U,{message:"No metrics to compare"}):e.jsx("div",{className:"rounded-md border border-border overflow-hidden",children:e.jsxs(re,{children:[e.jsx(ne,{children:e.jsxs(B,{children:[e.jsx(f,{children:"Metric"}),e.jsx(f,{className:"text-right",children:s.tag_a}),e.jsx(f,{className:"text-right",children:s.tag_b}),e.jsx(f,{className:"text-right",children:"Delta"}),e.jsx(f,{className:"text-right",children:"Change"})]})}),e.jsx(oe,{children:s.metrics.map(r=>e.jsxs(B,{children:[e.jsx(b,{children:r.metric_name}),e.jsx(b,{className:"font-mono text-right",children:r.tag_a_value.toFixed(2)}),e.jsx(b,{className:"font-mono text-right",children:r.tag_b_value.toFixed(2)}),e.jsxs(b,{className:"font-mono text-right",children:[r.absolute_delta>=0?"+":"",r.absolute_delta.toFixed(2)]}),e.jsxs(b,{className:Q("font-mono text-right",r.is_improvement?"text-green-500":"text-red-400"),children:[r.percentage_delta>=0?"+":"",H(r.percentage_delta/100)]})]},r.metric_name))})]})})]})]})]})}function Ze(){const[t,a]=u.useState(null),d=u.useCallback(i=>{a(l=>l===i?null:i)},[]);return e.jsx(G,{title:"Experiments",subtitle:"Tag sessions and compare outcomes",children:e.jsxs("div",{className:"space-y-6",children:[e.jsx(we,{onTagClick:d,expandedTag:t}),e.jsx(Ke,{}),e.jsx(Me,{})]})})}export{Ze as default};
