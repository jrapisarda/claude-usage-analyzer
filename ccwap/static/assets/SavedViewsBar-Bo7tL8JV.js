import{u as V,b as h,c as f,j as r}from"./query-vendor-ChV-W4bE.js";import{r as g}from"./react-vendor-yhu9f3WU.js";import{a6 as c,i as u,j as E,k as O,a7 as l,B as m}from"./index-Dqq8KNVg.js";import{S as L,a as R,b as B,c as I,d as N}from"./select-DG8x8Pg5.js";function U(e){return V({queryKey:c.views(e),queryFn:()=>u(`/saved-views${E({page:e})}`)})}function J(e){const i=h();return f({mutationFn:s=>u("/saved-views",{method:"POST",body:JSON.stringify({...s,page:e})}),onSuccess:()=>{i.invalidateQueries({queryKey:c.views(e)})}})}function M(e){const i=h();return f({mutationFn:s=>u(`/saved-views/${s}`,{method:"DELETE"}),onSuccess:()=>{i.invalidateQueries({queryKey:c.views(e)})}})}function P(e){const i=h();return f({mutationFn:s=>u("/alert-rules",{method:"POST",body:JSON.stringify({...s,page:e,enabled:s.enabled??!0})}),onSuccess:()=>{i.invalidateQueries({queryKey:c.alerts(e)})}})}function G(e){const i=h();return f({mutationFn:s=>u(`/alert-rules/${s}`,{method:"DELETE"}),onSuccess:()=>{i.invalidateQueries({queryKey:c.alerts(e)})}})}function H(e,i,s){return V({queryKey:c.alertEval(e,i,s),queryFn:()=>u(`/alert-rules/evaluate${E({page:e,from:i,to:s})}`)})}function ee({page:e,currentFilters:i,onApply:s,from:x,to:S,defaultMetricForAlert:y}){const[p,$]=g.useState(""),[b,j]=O(`ccwap:alerts:notified:${e}`,[]),{data:A}=U(e),{data:v}=H(e,x,S),q=J(e),k=M(e),D=P(e),F=G(e),w=A?.views??[],o=g.useMemo(()=>w.find(t=>String(t.id)===p),[w,p]);g.useEffect(()=>{const t=(v?.evaluations??[]).filter(n=>n.triggered);if(t.length===0)return;const a=t.map(n=>`${n.rule_id}:${x??""}:${S??""}`).filter(n=>!b.includes(n));if(a.length===0)return;const d=t[0];l({title:`Alert Triggered (${e})`,description:`${d.name}: ${d.current_value.toFixed(4)} ${d.operator} ${d.threshold.toFixed(4)}`,variant:"destructive"}),j(n=>[...n,...a].slice(-100))},[v,x,b,e,j,S]);const T=()=>{const t=window.prompt(`Name this ${e} view:`);t&&q.mutate({name:t.trim(),filters:i},{onSuccess:()=>{l({title:"Saved view created",description:t,variant:"success"})},onError:a=>{l({title:"Failed to save view",description:a?.message??"Unknown error",variant:"destructive"})}})},K=()=>{o&&window.confirm(`Delete saved view "${o.name}"?`)&&k.mutate(o.id,{onSuccess:()=>{$(""),l({title:"Saved view deleted",description:o.name,variant:"success"})},onError:t=>{l({title:"Failed to delete view",description:t?.message??"Unknown error",variant:"destructive"})}})},Q=()=>{const t=window.prompt(`Alert name for ${e}:`);if(!t)return;const a=window.prompt("Metric key:",y)||y,d=window.prompt("Operator (> >= < <= == !=):",">")||">",n=window.prompt("Threshold numeric value:","0");if(!n)return;const C=Number(n);if(Number.isNaN(C)){l({title:"Invalid threshold",description:n,variant:"destructive"});return}D.mutate({name:t.trim(),metric:a.trim(),operator:d.trim(),threshold:C,filters:i},{onSuccess:()=>{l({title:"Alert rule created",description:t,variant:"success"})},onError:z=>{l({title:"Failed to create alert",description:z?.message??"Unknown error",variant:"destructive"})}})},_=()=>{const t=(v?.evaluations??[]).filter(a=>a.triggered);if(t.length!==0&&window.confirm(`Delete ${t.length} triggered alert rule(s) for ${e}?`))for(const a of t)F.mutate(a.rule_id)};return r.jsxs("div",{className:"rounded-md border border-border p-3 mb-4 flex flex-wrap items-center gap-2",children:[r.jsx("span",{className:"text-xs text-muted-foreground",children:"Saved Views"}),r.jsxs(L,{value:p,onValueChange:$,children:[r.jsx(R,{className:"w-[220px] h-8",children:r.jsx(B,{placeholder:`Choose ${e} view`})}),r.jsx(I,{children:w.length===0?r.jsx(N,{value:"__none__",disabled:!0,children:"No saved views"}):w.map(t=>r.jsx(N,{value:String(t.id),children:t.name},t.id))})]}),r.jsx(m,{size:"sm",variant:"outline",onClick:()=>o&&s(o.filters),disabled:!o,children:"Apply"}),r.jsx(m,{size:"sm",variant:"outline",onClick:T,children:"Save Current"}),r.jsx(m,{size:"sm",variant:"outline",onClick:K,disabled:!o,children:"Delete View"}),r.jsx("span",{className:"mx-2 h-5 w-px bg-border"}),r.jsx(m,{size:"sm",variant:"outline",onClick:Q,children:"Add Alert"}),r.jsx(m,{size:"sm",variant:"outline",onClick:_,children:"Clear Triggered Alerts"}),r.jsxs("span",{className:"text-xs text-muted-foreground",children:["Triggered: ",(v?.evaluations??[]).filter(t=>t.triggered).length]})]})}export{ee as S};
