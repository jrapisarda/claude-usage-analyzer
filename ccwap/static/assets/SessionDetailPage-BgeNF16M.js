import{j as e}from"./query-vendor-DAETOSEH.js";import{e as D,r as d,L as O}from"./react-vendor-CGr-4ZyM.js";import{T as M,a as g}from"./chartConfig-CHOlO3Nn.js";import{f as n,L as R,a as h,c as E,e as N}from"./index-DZMFuYgm.js";import{b as C,B as I,X as W,Y as B,T,L as K,e as b,P,f as A,C as $}from"./chart-vendor-Df4oWUqu.js";import{P as z}from"./PageLayout-DEtLmFLB.js";import{a as H}from"./sessions-_V8NQoi3.js";import{E as X}from"./ErrorState-xqkb_4mP.js";import{M as j}from"./MetricCard-BoawkqIY.js";import{E as F}from"./ExportDropdown-B2A0w648.js";import{A as Y}from"./arrow-left-Az4NKZJP.js";import{X as V}from"./x-sdSrIrfi.js";import"./download-Bat12fqC.js";function U({turns:t}){return t.length===0?e.jsx("p",{className:"text-sm text-muted-foreground",children:"No turn data available"}):e.jsx("div",{className:"h-72",children:e.jsx(C,{width:"100%",height:"100%",children:e.jsxs(I,{data:t,margin:{top:4,right:8,left:0,bottom:4},children:[e.jsx(W,{dataKey:"turn_number",tick:{fontSize:10},stroke:"var(--color-muted-foreground)",label:{value:"Turn",position:"insideBottom",offset:-2,fontSize:11,fill:"var(--color-muted-foreground)"}}),e.jsx(B,{tick:{fontSize:10},stroke:"var(--color-muted-foreground)",tickFormatter:s=>n(s),width:55}),e.jsx(T,{contentStyle:M,formatter:(s,o)=>[n(s),o],labelFormatter:s=>`Turn ${s}`}),e.jsx(K,{wrapperStyle:{fontSize:11}}),e.jsx(b,{dataKey:"input_tokens",stackId:"tokens",fill:g.input,name:"Input"}),e.jsx(b,{dataKey:"output_tokens",stackId:"tokens",fill:g.output,name:"Output"}),e.jsx(b,{dataKey:"cache_read_tokens",stackId:"tokens",fill:g.cache_read,name:"Cache Read"}),e.jsx(b,{dataKey:"cache_write_tokens",stackId:"tokens",fill:g.cache_write,name:"Cache Write",radius:[4,4,0,0]})]})})})}const _=["var(--color-chart-1)","var(--color-chart-2)","var(--color-chart-3)","var(--color-chart-4)","var(--color-chart-5)"],q=24,G=200;function J({turn:t,width:s,isSelected:o,onClick:i}){const l=t.tool_calls.some(u=>!u.success),m=t.stop_reason==="max_tokens",c=Math.min(t.cost*500,1);return e.jsxs("button",{onClick:i,className:N("h-16 shrink-0 rounded-sm transition-all relative group",o?"ring-2 ring-primary":"hover:ring-1 hover:ring-primary/50",l&&"border-2 border-red-500",m&&!l&&"border-2 border-yellow-500"),style:{width:`${s}px`,backgroundColor:`color-mix(in srgb, var(--color-chart-1) ${Math.round(c*100)}%, var(--color-muted) 30%)`},children:[e.jsxs("div",{className:"absolute bottom-full left-1/2 -translate-x-1/2 mb-1.5 px-2 py-1 rounded bg-popover border border-border text-popover-foreground text-[10px] whitespace-nowrap opacity-0 group-hover:opacity-100 pointer-events-none z-20 shadow-md",children:[t.entry_type," · ",h(t.cost)," · ",n(t.input_tokens+t.output_tokens)," tokens"]}),t.is_sidechain&&e.jsx("div",{className:"absolute top-0 right-0 w-2 h-2 rounded-full bg-purple-500"}),t.is_meta&&e.jsx("div",{className:"absolute top-0 left-0 w-2 h-2 rounded-full bg-cyan-500"}),e.jsx("span",{className:"absolute bottom-0.5 left-0 right-0 text-[9px] text-center opacity-0 group-hover:opacity-100 truncate px-0.5",children:h(t.cost)})]})}function Q({turns:t,blockWidths:s,containerWidth:o}){if(t.length<2)return null;const i=t[t.length-1].cumulative_cost||1,l=60,m=4;let c=0;const u=t.map((v,x)=>{const f=s[x],y=c+f/2;c+=f+m;const p=l-v.cumulative_cost/i*(l-4);return`${y},${p}`});return e.jsx("svg",{className:"absolute top-0 left-0 pointer-events-none",width:o,height:l,style:{overflow:"visible"},children:e.jsx("polyline",{points:u.join(" "),fill:"none",stroke:"var(--color-chart-2)",strokeWidth:1.5,strokeOpacity:.6})})}function Z({turn:t,onClose:s}){return e.jsxs("div",{className:"w-96 border-l border-border bg-card p-4 overflow-y-auto",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"font-medium",children:"Turn Detail"}),e.jsx("button",{onClick:s,className:"p-1 rounded hover:bg-accent",children:e.jsx(V,{className:"h-4 w-4"})})]}),e.jsxs("div",{className:"space-y-3 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"Type"}),e.jsx("span",{children:t.entry_type})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"Model"}),e.jsx("span",{className:"font-mono",children:t.model||"N/A"})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"Cost"}),e.jsx("span",{className:"font-mono",children:h(t.cost)})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"Cumulative"}),e.jsx("span",{className:"font-mono",children:h(t.cumulative_cost)})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"Stop Reason"}),e.jsx("span",{children:t.stop_reason||"N/A"})]}),t.timestamp&&e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"Time"}),e.jsx("span",{children:new Date(t.timestamp).toLocaleTimeString()})]}),e.jsxs("div",{className:"border-t border-border pt-3",children:[e.jsx("h4",{className:"font-medium text-muted-foreground mb-2",children:"Tokens"}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"Input"}),e.jsx("span",{className:"font-mono",children:n(t.input_tokens)})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"Output"}),e.jsx("span",{className:"font-mono",children:n(t.output_tokens)})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"Cache Read"}),e.jsx("span",{className:"font-mono",children:n(t.cache_read_tokens)})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"Cache Write"}),e.jsx("span",{className:"font-mono",children:n(t.cache_write_tokens)})]})]})]}),t.thinking_chars>0&&e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"Thinking"}),e.jsxs("span",{className:"font-mono",children:[n(t.thinking_chars)," chars"]})]}),t.user_prompt_preview&&e.jsxs("div",{className:"border-t border-border pt-3",children:[e.jsx("h4",{className:"font-medium text-muted-foreground mb-2",children:"User Prompt"}),e.jsx("p",{className:"text-xs bg-muted/50 p-2 rounded whitespace-pre-wrap break-words",children:t.user_prompt_preview})]}),t.tool_calls.length>0&&e.jsxs("div",{className:"border-t border-border pt-3",children:[e.jsxs("h4",{className:"font-medium text-muted-foreground mb-2",children:["Tool Calls (",t.tool_calls.length,")"]}),e.jsx("div",{className:"space-y-2",children:t.tool_calls.map((o,i)=>e.jsxs("div",{className:N("p-2 rounded text-xs",o.success?"bg-muted/50":"bg-red-500/10 border border-red-500/30"),children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"font-medium",children:o.tool_name}),!o.success&&e.jsx("span",{className:"text-red-400 text-[10px]",children:"FAILED"})]}),o.file_path&&e.jsx("div",{className:"text-muted-foreground truncate mt-0.5",children:o.file_path}),o.loc_written>0&&e.jsxs("div",{className:"text-muted-foreground mt-0.5",children:["+",o.lines_added,"/-",o.lines_deleted," (",o.loc_written," LOC)"]}),o.error_message&&e.jsx("div",{className:"text-red-400 mt-1 break-words",children:o.error_message})]},i))})]}),e.jsxs("div",{className:"flex gap-1 mt-2",children:[t.is_sidechain&&e.jsx("span",{className:"text-xs bg-purple-500/20 text-purple-400 px-1.5 py-0.5 rounded",children:"sidechain"}),t.is_meta&&e.jsx("span",{className:"text-xs bg-cyan-500/20 text-cyan-400 px-1.5 py-0.5 rounded",children:"meta"})]})]})]})}function xe(){const{id:t}=D(),{data:s,isLoading:o,error:i}=H(t),[l,m]=d.useState(null),[c,u]=d.useState("cost"),v=d.useRef(null),x=d.useMemo(()=>{if(!s)return[];const r=Math.max(...s.turns.map(a=>a.input_tokens+a.output_tokens),1);return s.turns.map(a=>{const L=(a.input_tokens+a.output_tokens)/r;return Math.max(q,Math.round(L*G))})},[s]),f=d.useMemo(()=>x.reduce((a,w)=>a+w+4,0)-4,[x]),y=d.useMemo(()=>s?s.turns.map((r,a)=>({turn_number:a+1,input_tokens:r.input_tokens,output_tokens:r.output_tokens,cache_read_tokens:r.cache_read_tokens,cache_write_tokens:r.cache_write_tokens})):[],[s]),p=d.useMemo(()=>s?.tool_distribution?Object.entries(s.tool_distribution).sort((r,a)=>a[1]-r[1]).slice(0,10).map(([r,a])=>({name:r,value:a})):[],[s]),S=d.useCallback(r=>{m(a=>a===r?null:r)},[]);if(o)return e.jsx(R,{message:"Loading session replay..."});if(i)return e.jsx(X,{message:i.message});if(!s)return null;const k=l!==null?s.turns[l]:null;return e.jsxs(z,{title:"Session Detail",subtitle:"Turn-by-turn session replay",actions:s&&e.jsx(F,{page:`session-${t}`,getData:()=>(s?.turns||[]).map((r,a)=>({turn:a+1,entry_type:r.entry_type,model:r.model,input_tokens:r.input_tokens,output_tokens:r.output_tokens,cost:r.cost,cumulative_cost:r.cumulative_cost,stop_reason:r.stop_reason||"",is_sidechain:r.is_sidechain,user_prompt_preview:r.user_prompt_preview||""})),columns:["turn","entry_type","model","input_tokens","output_tokens","cost","cumulative_cost","stop_reason","is_sidechain","user_prompt_preview"]}),children:[e.jsxs(O,{to:"/projects",className:"inline-flex items-center gap-1 text-sm text-muted-foreground hover:text-foreground mb-4",children:[e.jsx(Y,{className:"h-4 w-4"})," Back to projects"]}),e.jsxs("div",{className:"rounded-lg border border-border bg-card p-4 mb-6",children:[e.jsxs("div",{className:"flex flex-wrap items-center gap-x-4 gap-y-1 text-sm",children:[e.jsx("span",{className:"font-medium text-lg",children:s.project_display||s.project_path}),s.is_agent&&e.jsx("span",{className:"text-xs bg-purple-500/20 text-purple-400 px-1.5 py-0.5 rounded",children:"agent"}),s.cc_version&&e.jsxs("span",{className:"text-muted-foreground",children:["v",s.cc_version]}),s.git_branch&&e.jsx("span",{className:"text-muted-foreground font-mono",children:s.git_branch})]}),e.jsxs("div",{className:"flex flex-wrap gap-4 mt-2 text-xs text-muted-foreground",children:[s.first_timestamp&&e.jsx("span",{children:new Date(s.first_timestamp).toLocaleString()}),e.jsxs("span",{className:"font-mono",children:[s.session_id.slice(0,12),"..."]})]})]}),e.jsxs("div",{className:"grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-4 mb-6",children:[e.jsx(j,{title:"Cost",value:h(s.total_cost)}),e.jsx(j,{title:"Duration",value:E(s.duration_seconds)}),e.jsx(j,{title:"Turns",value:n(s.total_turns),subtitle:`${s.total_user_turns} user`}),e.jsx(j,{title:"Tool Calls",value:n(s.total_tool_calls)}),e.jsx(j,{title:"Errors",value:n(s.total_errors),className:s.total_errors>0?"border-amber-500/50 bg-amber-500/10":void 0})]}),e.jsxs("div",{className:"flex gap-6",children:[e.jsxs("div",{className:"flex-1 min-w-0 space-y-6",children:[e.jsxs("div",{className:"rounded-lg border border-border bg-card p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h3",{className:"text-sm font-medium text-muted-foreground",children:"Timeline"}),e.jsxs("div",{className:"flex gap-3 text-[10px] text-muted-foreground",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx("span",{className:"w-2 h-2 rounded-full bg-red-500"})," Error"]}),e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx("span",{className:"w-2 h-2 rounded-full bg-yellow-500"})," Truncation"]}),e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx("span",{className:"w-2 h-2 rounded-full bg-purple-500"})," Sidechain"]}),e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx("span",{className:"w-2 h-2 rounded-full bg-cyan-500"})," Meta"]})]})]}),e.jsx("div",{ref:v,className:"overflow-x-auto relative",style:{minHeight:"80px"},children:e.jsxs("div",{className:"relative",style:{width:`${f}px`,minWidth:"100%"},children:[e.jsx(Q,{turns:s.turns,blockWidths:x,containerWidth:f}),e.jsx("div",{className:"flex gap-1 relative z-10",children:s.turns.map((r,a)=>e.jsx(J,{turn:r,width:x[a],isSelected:l===a,onClick:()=>S(a)},r.uuid))})]})})]}),e.jsxs("div",{className:"flex items-center gap-1 rounded-lg border border-border bg-card p-1 w-fit",children:[e.jsx("button",{onClick:()=>u("cost"),className:N("px-3 py-1.5 text-xs font-medium rounded-md transition-colors",c==="cost"?"bg-primary text-primary-foreground":"text-muted-foreground hover:text-foreground hover:bg-accent/50"),children:"Cost Breakdown"}),e.jsx("button",{onClick:()=>u("tokens"),className:N("px-3 py-1.5 text-xs font-medium rounded-md transition-colors",c==="tokens"?"bg-primary text-primary-foreground":"text-muted-foreground hover:text-foreground hover:bg-accent/50"),children:"Token Waterfall"})]}),c==="cost"?e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[Object.keys(s.cost_by_model).length>0&&e.jsxs("div",{className:"rounded-lg border border-border bg-card p-4",children:[e.jsx("h3",{className:"text-sm font-medium text-muted-foreground mb-3",children:"Cost by Model"}),e.jsx("div",{className:"space-y-2",children:Object.entries(s.cost_by_model).sort((r,a)=>a[1]-r[1]).map(([r,a])=>e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"truncate font-mono",children:r}),e.jsx("span",{className:"font-mono shrink-0 ml-2",children:h(a)})]},r))})]}),p.length>0&&e.jsxs("div",{className:"rounded-lg border border-border bg-card p-4",children:[e.jsx("h3",{className:"text-sm font-medium text-muted-foreground mb-3",children:"Tool Distribution"}),e.jsx("div",{className:"h-48",children:e.jsx(C,{width:"100%",height:"100%",children:e.jsxs(P,{children:[e.jsx(A,{data:p,dataKey:"value",nameKey:"name",cx:"50%",cy:"50%",outerRadius:70,strokeWidth:0,children:p.map((r,a)=>e.jsx($,{fill:_[a%_.length]},a))}),e.jsx(T,{contentStyle:{backgroundColor:"var(--color-card)",color:"var(--color-card-foreground)",border:"1px solid var(--color-border)",borderRadius:"6px",fontSize:"12px"}})]})})}),e.jsx("div",{className:"flex flex-wrap gap-2 mt-2",children:p.map((r,a)=>e.jsxs("span",{className:"text-[10px] flex items-center gap-1",children:[e.jsx("span",{className:"w-2 h-2 rounded-full",style:{backgroundColor:_[a%_.length]}}),r.name," (",r.value,")"]},r.name))})]})]}):e.jsxs("div",{className:"rounded-lg border border-border bg-card p-4",children:[e.jsx("h3",{className:"text-sm font-medium text-muted-foreground mb-3",children:"Token Breakdown per Turn"}),e.jsx(U,{turns:y})]})]}),k&&e.jsx(Z,{turn:k,onClose:()=>m(null)})]})]})}export{xe as default};
