import{u as ce,j as e}from"./query-vendor-DAETOSEH.js";import{r as h}from"./react-vendor-CGr-4ZyM.js";import{P as ve}from"./PageLayout-DEtLmFLB.js";import{M as P}from"./MetricCard-BoawkqIY.js";import{C as p}from"./ChartCard-Cn7QorEQ.js";import{g as de,h as ue,r as he,u as ye,L as Se,f as G,e as _e,a as ke,c as Ne}from"./index-DZMFuYgm.js";import{E as we}from"./ErrorState-xqkb_4mP.js";import{E as te}from"./EmptyState-D7Ng6sxx.js";import{f as ae,C as l,T as f}from"./chartConfig-CHOlO3Nn.js";import{b as g,i as se,X as w,Y as T,T as v,j as le,A as re,d as ne,L as O,B as X,e as Y,P as Te,f as De,C as Ce,k as Ke,l as Le,m as Re,n as Ee,o as Ae,p as Me}from"./chart-vendor-Df4oWUqu.js";import{X as $e}from"./x-sdSrIrfi.js";import{C as ze}from"./chevron-down-CG6zLN1w.js";function Oe(s){return ce({queryKey:he.query(s),queryFn:()=>de(`/explorer${ue({metric:s.metric,group_by:s.group_by,split_by:s.split_by,from:s.from,to:s.to,projects:s.projects,models:s.models,branches:s.branches,languages:s.languages})}`),enabled:!!s.metric&&!!s.group_by})}function Be(s,r){return ce({queryKey:he.filters(s,r),queryFn:()=>de(`/explorer/filters${ue({from:s,to:r})}`)})}const oe=[{value:"cost",label:"Cost ($)",group:"Turns"},{value:"input_tokens",label:"Input Tokens",group:"Turns"},{value:"output_tokens",label:"Output Tokens",group:"Turns"},{value:"cache_read_tokens",label:"Cache Read Tokens",group:"Turns"},{value:"cache_write_tokens",label:"Cache Write Tokens",group:"Turns"},{value:"ephemeral_5m_tokens",label:"Ephemeral 5m Tokens",group:"Turns"},{value:"ephemeral_1h_tokens",label:"Ephemeral 1h Tokens",group:"Turns"},{value:"thinking_chars",label:"Thinking Chars",group:"Turns"},{value:"turns_count",label:"Turns Count",group:"Turns"},{value:"loc_written",label:"LOC Written",group:"Tools"},{value:"tool_calls_count",label:"Tool Calls",group:"Tools"},{value:"errors",label:"Errors",group:"Tools"},{value:"lines_added",label:"Lines Added",group:"Tools"},{value:"lines_deleted",label:"Lines Deleted",group:"Tools"},{value:"sessions_count",label:"Sessions",group:"Sessions"},{value:"duration_seconds",label:"Duration (s)",group:"Sessions"}],ie=[{value:"date",label:"Date"},{value:"model",label:"Model"},{value:"project",label:"Project"},{value:"branch",label:"Branch"},{value:"language",label:"Language"},{value:"tool_name",label:"Tool Name"},{value:"cc_version",label:"CC Version"},{value:"entry_type",label:"Entry Type"},{value:"is_agent",label:"Agent/User"}],Pe=new Set(["date","model","project","branch","cc_version","entry_type","is_agent"]),Ie=new Set(["date","model","project","branch","language","tool_name","cc_version","entry_type","is_agent"]),Ge=new Set(["date","project","branch","cc_version","is_agent"]),Fe=new Set(["cost","input_tokens","output_tokens","cache_read_tokens","cache_write_tokens","ephemeral_5m_tokens","ephemeral_1h_tokens","thinking_chars","turns_count"]),qe=new Set(["loc_written","tool_calls_count","errors","lines_added","lines_deleted"]);function We(s){return s?Fe.has(s)?Pe:qe.has(s)?Ie:Ge:new Set}function V(s,r){return r==="cost"?ke(s):r==="duration_seconds"?Ne(s):G(s)}function I({label:s,options:r,selected:m,onChange:S}){const[K,_]=h.useState(!1),D=h.useRef(null);h.useEffect(()=>{function o(k){D.current&&!D.current.contains(k.target)&&_(!1)}return document.addEventListener("mousedown",o),()=>document.removeEventListener("mousedown",o)},[]);const L=h.useCallback(o=>{S(m.includes(o)?m.filter(k=>k!==o):[...m,o])},[m,S]);return e.jsxs("div",{className:"relative",ref:D,children:[e.jsxs("button",{type:"button",onClick:()=>_(!K),className:_e("flex items-center gap-1.5 w-full px-3 py-1.5 text-sm rounded-md border border-border bg-background","hover:bg-accent/50 text-left",m.length>0&&"ring-1 ring-primary/30"),children:[e.jsx("span",{className:"flex-1 truncate",children:m.length>0?`${s} (${m.length})`:s}),m.length>0&&e.jsx($e,{className:"h-3 w-3 text-muted-foreground hover:text-foreground shrink-0",onClick:o=>{o.stopPropagation(),S([])}}),e.jsx(ze,{className:"h-3.5 w-3.5 text-muted-foreground shrink-0"})]}),K&&e.jsx("div",{className:"absolute z-50 mt-1 w-64 max-h-60 overflow-y-auto rounded-md border border-border bg-card shadow-lg",children:r.length===0?e.jsx("p",{className:"px-3 py-2 text-xs text-muted-foreground",children:"No options"}):r.map(o=>e.jsxs("label",{className:"flex items-center gap-2 px-3 py-1.5 hover:bg-accent/50 cursor-pointer text-sm",children:[e.jsx("input",{type:"checkbox",checked:m.includes(o.value),onChange:()=>L(o.value),className:"rounded border-border"}),e.jsx("span",{className:"flex-1 truncate",children:o.label}),e.jsx("span",{className:"text-xs text-muted-foreground",children:o.count})]},o.value))})]})}function lt(){const{dateRange:s}=ye(),[r,m]=h.useState(null),[S,K]=h.useState(null),[_,D]=h.useState(null),[L,o]=h.useState([]),[k,me]=h.useState([]),[F,xe]=h.useState([]),[q,pe]=h.useState([]),C=We(r),j=S&&C.has(S)?S:null,R=_&&C.has(_)&&_!==j?_:null,ge={metric:r,group_by:j,split_by:R,from:s.from,to:s.to,projects:L.length?L.join(","):null,models:k.length?k.join(","):null,branches:F.length?F.join(","):null,languages:q.length?q.join(","):null},{data:c,isLoading:je,error:H}=Oe(ge),{data:E}=Be(s.from,s.to),N=j==="date",x=!!R,i=oe.find(t=>t.value===r)?.label??r??"",{timeData:B,catData:W,pieData:Z,treemapData:be,radarData:Q,splitKeys:A,tableRows:J}=h.useMemo(()=>{if(!c||c.rows.length===0)return{timeData:[],catData:[],pieData:[],treemapData:[],radarData:[],splitKeys:[],tableRows:[]};const t=c.rows,a=c.metadata.splits;if(N&&x){const n=new Map;for(const u of t){n.has(u.group)||n.set(u.group,{date:u.group});const $=n.get(u.group);$[u.split??""]=u.value}return{timeData:ae(Array.from(n.values()).sort((u,$)=>u.date.localeCompare($.date)),a),catData:[],pieData:[],treemapData:[],radarData:[],splitKeys:a,tableRows:t}}if(N)return{timeData:[...t].map(d=>({date:d.group,value:d.value})).sort((d,u)=>d.date.localeCompare(u.date)),catData:[],pieData:[],treemapData:[],radarData:[],splitKeys:[],tableRows:t};if(x){const n=new Map;for(const b of t){n.has(b.group)||n.set(b.group,{name:b.group,total:0});const z=n.get(b.group);z[b.split??""]=b.value,z.total=(z.total||0)+b.value}const d=ae(Array.from(n.values()).sort((b,z)=>z.total-b.total),a),u=d.slice(0,20),$=d.slice(0,8);return{timeData:[],catData:u,pieData:[],treemapData:[],radarData:$,splitKeys:a,tableRows:t}}const y=[...t].map(n=>({name:n.group,value:n.value})).sort((n,d)=>d.value-n.value),M=y.slice(0,20),U=y.slice(0,10),fe=y.slice(0,30).map((n,d)=>({...n,fill:l[d%l.length]}));return{timeData:[],catData:M,pieData:U,treemapData:fe,radarData:[],splitKeys:[],tableRows:t}},[c,N,x]);return e.jsxs(ve,{title:"Analytics Explorer",subtitle:"Query any metric by any dimension",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-3 mb-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-muted-foreground mb-1",children:"Metric"}),e.jsxs("select",{value:r??"",onChange:t=>{m(t.target.value||null),K(null),D(null)},className:"w-full px-3 py-1.5 text-sm rounded-md border border-border bg-background",children:[e.jsx("option",{value:"",children:"Select metric..."}),["Turns","Tools","Sessions"].map(t=>e.jsx("optgroup",{label:t,children:oe.filter(a=>a.group===t).map(a=>e.jsx("option",{value:a.value,children:a.label},a.value))},t))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-muted-foreground mb-1",children:"Group By"}),e.jsxs("select",{value:j??"",onChange:t=>K(t.target.value||null),className:"w-full px-3 py-1.5 text-sm rounded-md border border-border bg-background",disabled:!r,children:[e.jsx("option",{value:"",children:"Select dimension..."}),ie.map(t=>e.jsxs("option",{value:t.value,disabled:!C.has(t.value),children:[t.label,C.has(t.value)?"":" (N/A)"]},t.value))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-muted-foreground mb-1",children:"Split By (optional)"}),e.jsxs("select",{value:R??"",onChange:t=>D(t.target.value||null),className:"w-full px-3 py-1.5 text-sm rounded-md border border-border bg-background",disabled:!r||!j,children:[e.jsx("option",{value:"",children:"None"}),ie.filter(t=>t.value!==j).map(t=>e.jsxs("option",{value:t.value,disabled:!C.has(t.value),children:[t.label,C.has(t.value)?"":" (N/A)"]},t.value))]})]})]}),E&&e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-3 mb-6",children:[e.jsx(I,{label:"Projects",options:E.projects,selected:L,onChange:o}),e.jsx(I,{label:"Models",options:E.models,selected:k,onChange:me}),e.jsx(I,{label:"Branches",options:E.branches,selected:F,onChange:xe}),e.jsx(I,{label:"Languages",options:E.languages,selected:q,onChange:pe})]}),!r||!j?e.jsx(te,{message:"Select a metric and dimension to explore"}):je?e.jsx(Se,{message:"Querying data..."}):H?e.jsx(we,{message:H.message}):!c||c.rows.length===0?e.jsx(te,{message:"No data for current selection"}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6",children:[e.jsx(P,{title:"Total",value:V(c.metadata.total,r)}),e.jsx(P,{title:"Data Points",value:G(c.metadata.row_count)}),e.jsx(P,{title:"Groups",value:G(c.metadata.groups.length)}),e.jsx(P,{title:x?"Splits":"Avg per Group",value:x?G(c.metadata.splits.length):V(c.metadata.total/Math.max(c.metadata.groups.length,1),r)})]}),N&&!x&&e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-4 mb-6",children:[e.jsx(p,{title:`${i} Over Time`,subtitle:"Line chart",children:e.jsx("div",{className:"h-80",children:e.jsx(g,{width:"100%",height:"100%",children:e.jsxs(se,{data:B,children:[e.jsx(w,{dataKey:"date",tick:{fontSize:10}}),e.jsx(T,{tick:{fontSize:10}}),e.jsx(v,{contentStyle:f}),e.jsx(le,{type:"monotone",dataKey:"value",stroke:l[0],strokeWidth:2,dot:{r:3},name:i})]})})})}),e.jsx(p,{title:`${i} Over Time`,subtitle:"Area chart",children:e.jsx("div",{className:"h-80",children:e.jsx(g,{width:"100%",height:"100%",children:e.jsxs(re,{data:B,children:[e.jsx("defs",{children:e.jsxs("linearGradient",{id:"explorerGrad",x1:"0",y1:"0",x2:"0",y2:"1",children:[e.jsx("stop",{offset:"5%",stopColor:l[0],stopOpacity:.3}),e.jsx("stop",{offset:"95%",stopColor:l[0],stopOpacity:0})]})}),e.jsx(w,{dataKey:"date",tick:{fontSize:10}}),e.jsx(T,{tick:{fontSize:10}}),e.jsx(v,{contentStyle:f}),e.jsx(ne,{type:"monotone",dataKey:"value",stroke:l[0],fill:"url(#explorerGrad)",name:i})]})})})})]}),N&&x&&e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-4 mb-6",children:[e.jsx(p,{title:`${i} by ${R}`,subtitle:"Multi-line chart",children:e.jsx("div",{className:"h-80",children:e.jsx(g,{width:"100%",height:"100%",children:e.jsxs(se,{data:B,children:[e.jsx(w,{dataKey:"date",tick:{fontSize:10}}),e.jsx(T,{tick:{fontSize:10}}),e.jsx(v,{contentStyle:f}),e.jsx(O,{}),A.map((t,a)=>e.jsx(le,{type:"monotone",dataKey:t,stroke:l[a%l.length],strokeWidth:2,dot:!1,name:t},t))]})})})}),e.jsx(p,{title:`${i} Stacked`,subtitle:"Stacked area chart",children:e.jsx("div",{className:"h-80",children:e.jsx(g,{width:"100%",height:"100%",children:e.jsxs(re,{data:B,children:[e.jsx(w,{dataKey:"date",tick:{fontSize:10}}),e.jsx(T,{tick:{fontSize:10}}),e.jsx(v,{contentStyle:f}),e.jsx(O,{}),A.map((t,a)=>e.jsx(ne,{type:"monotone",dataKey:t,stackId:"1",stroke:l[a%l.length],fill:l[a%l.length],fillOpacity:.4,name:t},t))]})})})})]}),!N&&!x&&e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-4 mb-6",children:[e.jsx(p,{title:`${i} by ${j}`,subtitle:"Bar chart (top 20)",children:e.jsx("div",{className:"h-80",children:e.jsx(g,{width:"100%",height:"100%",children:e.jsxs(X,{data:W,layout:"vertical",children:[e.jsx(w,{type:"number",tick:{fontSize:10}}),e.jsx(T,{dataKey:"name",type:"category",width:100,tick:{fontSize:10}}),e.jsx(v,{contentStyle:f}),e.jsx(Y,{dataKey:"value",fill:l[0],radius:[0,4,4,0],name:i})]})})})}),e.jsx(p,{title:`${i} Distribution`,subtitle:"Donut chart (top 10)",children:e.jsx("div",{className:"h-80",children:e.jsx(g,{width:"100%",height:"100%",children:e.jsxs(Te,{children:[e.jsx(De,{data:Z,dataKey:"value",nameKey:"name",cx:"50%",cy:"50%",innerRadius:60,outerRadius:100,paddingAngle:2,label:({name:t,percent:a})=>`${t} ${(a*100).toFixed(0)}%`,labelLine:{strokeWidth:1},children:Z.map((t,a)=>e.jsx(Ce,{fill:l[a%l.length]},a))}),e.jsx(v,{contentStyle:f})]})})})}),e.jsx(p,{title:`${i} Treemap`,subtitle:"Top 30 by size",children:e.jsx("div",{className:"h-80",children:e.jsx(g,{width:"100%",height:"100%",children:e.jsx(Ke,{data:be,dataKey:"value",nameKey:"name",stroke:"var(--color-border)",content:({x:t,y:a,width:y,height:M,name:U,fill:ee})=>e.jsxs("g",{children:[e.jsx("rect",{x:t,y:a,width:y,height:M,fill:ee,rx:2}),y>=30&&M>=20&&e.jsx("text",{x:t+y/2,y:a+M/2,textAnchor:"middle",dominantBaseline:"middle",fill:"white",fontSize:10,children:String(U??"").slice(0,Math.floor(y/7))})]})})})})})]}),!N&&x&&e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-4 mb-6",children:[e.jsx(p,{title:`${i} Grouped`,subtitle:"Grouped bar chart",children:e.jsx("div",{className:"h-80",children:e.jsx(g,{width:"100%",height:"100%",children:e.jsxs(X,{data:W,children:[e.jsx(w,{dataKey:"name",tick:{fontSize:10},angle:-30,textAnchor:"end",height:60}),e.jsx(T,{tick:{fontSize:10}}),e.jsx(v,{contentStyle:f}),e.jsx(O,{}),A.map((t,a)=>e.jsx(Y,{dataKey:t,fill:l[a%l.length],radius:[4,4,0,0],name:t},t))]})})})}),e.jsx(p,{title:`${i} Stacked`,subtitle:"Stacked bar chart",children:e.jsx("div",{className:"h-80",children:e.jsx(g,{width:"100%",height:"100%",children:e.jsxs(X,{data:W,children:[e.jsx(w,{dataKey:"name",tick:{fontSize:10},angle:-30,textAnchor:"end",height:60}),e.jsx(T,{tick:{fontSize:10}}),e.jsx(v,{contentStyle:f}),e.jsx(O,{}),A.map((t,a)=>e.jsx(Y,{dataKey:t,stackId:"stack",fill:l[a%l.length],name:t},t))]})})})}),Q.length>0&&Q.length<=8&&e.jsx(p,{title:`${i} Radar`,subtitle:"Radar chart",children:e.jsx("div",{className:"h-80",children:e.jsx(g,{width:"100%",height:"100%",children:e.jsxs(Le,{data:Q,children:[e.jsx(Re,{}),e.jsx(Ee,{dataKey:"name",tick:{fontSize:10}}),e.jsx(Ae,{tick:{fontSize:9}}),A.map((t,a)=>e.jsx(Me,{dataKey:t,stroke:l[a%l.length],fill:l[a%l.length],fillOpacity:.2,name:t},t)),e.jsx(O,{}),e.jsx(v,{contentStyle:f})]})})})})]}),e.jsx(p,{title:"Raw Data",subtitle:`${J.length} rows (max 100 shown)`,children:e.jsx("div",{className:"max-h-96 overflow-auto",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"border-b border-border text-left",children:[e.jsx("th",{className:"py-2 px-3 font-medium text-muted-foreground",children:j}),x&&e.jsx("th",{className:"py-2 px-3 font-medium text-muted-foreground",children:R}),e.jsx("th",{className:"py-2 px-3 font-medium text-muted-foreground text-right",children:i})]})}),e.jsx("tbody",{children:J.slice(0,100).map((t,a)=>e.jsxs("tr",{className:"border-b border-border/50 hover:bg-accent/30",children:[e.jsx("td",{className:"py-1.5 px-3",children:t.group}),x&&e.jsx("td",{className:"py-1.5 px-3",children:t.split}),e.jsx("td",{className:"py-1.5 px-3 text-right font-mono",children:V(t.value,r)})]},a))})]})})})]})]})}export{lt as default};
