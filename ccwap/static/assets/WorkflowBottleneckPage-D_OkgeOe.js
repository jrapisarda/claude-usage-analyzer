import{j as e}from"./query-vendor-ChV-W4bE.js";import{r as T,L as S}from"./react-vendor-yhu9f3WU.js";import{P as x}from"./PageLayout-DNcy9VzK.js";import{C as m}from"./ChartContainer-BVfquKWB.js";import{D as C}from"./DataTable-DYmEQGcX.js";import{M as h,a as n}from"./MetricCardGrid-DncIdQee.js";import{E as K}from"./ErrorState-D6SGc0M3.js";import{u as w,f as o,b as c}from"./index-DOoA8ygH.js";import{c as R}from"./advanced-BunkG_h-.js";import{T as f,C as p}from"./chartConfig-C_qPkli-.js";import{B as j,X as u,Y as y,T as g,e as b}from"./chart-vendor-Dwd1Lo9s.js";import"./skeleton-4dVV08Mr.js";import"./table-1cB3eS_W.js";const B=[{accessorKey:"session_id",header:"Session",cell:({row:r})=>e.jsx(S,{to:`/sessions/${r.original.session_id}`,className:"font-mono text-xs text-primary hover:underline",children:r.original.session_id})},{accessorKey:"project",header:"Project",cell:({row:r})=>e.jsx("span",{className:"truncate block max-w-[220px]",children:r.original.project})},{accessorKey:"branch",header:"Branch",cell:({row:r})=>e.jsx("span",{className:"font-mono text-xs",children:r.original.branch})},{accessorKey:"user_type",header:"Type",cell:({row:r})=>e.jsx("span",{className:"capitalize",children:r.original.user_type})},{accessorKey:"failures",header:()=>e.jsx("div",{className:"text-right",children:"Failures"}),cell:({row:r})=>e.jsx("div",{className:"text-right font-mono",children:o(r.original.failures)})},{accessorKey:"retries",header:()=>e.jsx("div",{className:"text-right",children:"Retries"}),cell:({row:r})=>e.jsx("div",{className:"text-right font-mono",children:o(r.original.retries)})},{accessorKey:"stall_score",header:()=>e.jsx("div",{className:"text-right",children:"Stall Score"}),cell:({row:r})=>e.jsx("div",{className:"text-right font-mono",children:o(r.original.stall_score)})}];function X(){const{dateRange:r}=w(),{data:a,isLoading:_,error:d}=R(r),i=T.useMemo(()=>(a?.transition_matrix??[]).slice(0,15),[a?.transition_matrix]),N=(a?.retry_loops??[]).reduce((s,t)=>s+t.retries,0),k=(a?.failure_handoffs??[]).reduce((s,t)=>s+t.errors,0),v=i.length>0?i.reduce((s,t)=>s+t.failure_rate,0)/i.length:0;return d?e.jsx(K,{message:d.message}):_||!a?e.jsx(x,{title:"Workflow Bottlenecks",subtitle:"Transition failures, retry loops, and handoff stalls",children:e.jsx(h,{skeleton:!0,count:4,className:"mb-6"})}):e.jsxs(x,{title:"Workflow Bottlenecks",subtitle:"Show where human/agent workflows stall",children:[e.jsxs(h,{className:"mb-6",children:[e.jsx(n,{title:"Transitions",value:o(a.transition_matrix.length)}),e.jsx(n,{title:"Retry Loops",value:o(N)}),e.jsx(n,{title:"Failure Handoffs",value:o(k)}),e.jsx(n,{title:"Avg Transition Failure",value:c(v)})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6",children:[e.jsx(m,{title:"Transition Failure Matrix (Top)",height:320,isEmpty:i.length===0,children:e.jsxs(j,{data:i,layout:"vertical",children:[e.jsx(u,{type:"number",tick:{fontSize:10}}),e.jsx(y,{type:"category",dataKey:"to_tool",width:100,tick:{fontSize:10}}),e.jsx(g,{contentStyle:f,formatter:(s,t)=>t==="failure_rate"?c(s??0):o(s??0)}),e.jsx(b,{dataKey:"failures",fill:p[0],name:"Failures"})]})}),e.jsx(m,{title:"Retry Loops by Tool",height:320,isEmpty:a.retry_loops.length===0,children:e.jsxs(j,{data:Object.values(a.retry_loops.reduce((s,t)=>{const l=t.tool_name;return s[l]=s[l]||{tool_name:l,retries:0},s[l].retries+=t.retries,s},{})).sort((s,t)=>t.retries-s.retries).slice(0,12),children:[e.jsx(u,{dataKey:"tool_name",tick:{fontSize:10},angle:-20,textAnchor:"end",height:60}),e.jsx(y,{tick:{fontSize:10}}),e.jsx(g,{contentStyle:f}),e.jsx(b,{dataKey:"retries",fill:p[2]})]})})]}),e.jsxs("div",{className:"rounded-md border border-border overflow-hidden mb-6",children:[e.jsx("div",{className:"px-4 py-2 border-b border-border text-sm font-medium text-muted-foreground",children:"Failure Handoffs"}),e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"border-b border-border",children:[e.jsx("th",{className:"px-3 py-2 text-left",children:"Parent"}),e.jsx("th",{className:"px-3 py-2 text-left",children:"Child"}),e.jsx("th",{className:"px-3 py-2 text-left",children:"Branch"}),e.jsx("th",{className:"px-3 py-2 text-left",children:"Handoff"}),e.jsx("th",{className:"px-3 py-2 text-right",children:"Errors"}),e.jsx("th",{className:"px-3 py-2 text-right",children:"Error Rate"})]})}),e.jsx("tbody",{children:a.failure_handoffs.slice(0,20).map((s,t)=>e.jsxs("tr",{className:"border-b border-border/60",children:[e.jsx("td",{className:"px-3 py-2 font-mono text-xs",children:s.parent_session_id}),e.jsx("td",{className:"px-3 py-2 font-mono text-xs",children:s.child_session_id}),e.jsx("td",{className:"px-3 py-2",children:s.branch}),e.jsx("td",{className:"px-3 py-2",children:s.handoff}),e.jsx("td",{className:"px-3 py-2 text-right font-mono",children:o(s.errors)}),e.jsx("td",{className:"px-3 py-2 text-right font-mono",children:c(s.error_rate)})]},`${s.parent_session_id}-${s.child_session_id}-${t}`))})]})]}),e.jsx(C,{columns:B,data:a.blocked_sessions,emptyMessage:"No blocked sessions found"})]})}export{X as default};
