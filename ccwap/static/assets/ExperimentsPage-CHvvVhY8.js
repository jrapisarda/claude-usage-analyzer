import{u as y,b as R,c as D,j as e}from"./query-vendor-DAETOSEH.js";import{r as m,L as z}from"./react-vendor-CGr-4ZyM.js";import{P as O}from"./PageLayout-DEtLmFLB.js";import{d as $,k as p,g as h,h as v,u as C,L as N,b as E,e as q,a as B,f as Q}from"./index-DZMFuYgm.js";import{u as I}from"./projects-CXgDD7CH.js";import{E as _}from"./ErrorState-xqkb_4mP.js";import{E as T}from"./EmptyState-D7Ng6sxx.js";import{T as L,C as g}from"./chartConfig-CHOlO3Nn.js";import{P as U,T as X}from"./trash-2-C1zs9qV9.js";import{C as Y}from"./chevron-up-J1QIQPXH.js";import{C as H}from"./chevron-down-CG6zLN1w.js";import{X as V}from"./x-sdSrIrfi.js";import{b as P,B as G,X as J,Y as W,T as F,L as M,e as Z,l as ee,m as te,n as se,o as re,p as ae}from"./chart-vendor-Df4oWUqu.js";const oe=[["path",{d:"m16 3 4 4-4 4",key:"1x1c3m"}],["path",{d:"M20 7H4",key:"zbl0bi"}],["path",{d:"m8 21-4-4 4-4",key:"h9nckh"}],["path",{d:"M4 17h16",key:"g4d7ey"}]],ne=$("arrow-right-left",oe);function S(){return y({queryKey:p.tags,queryFn:()=>h("/experiments/tags")})}function de(r,a){return y({queryKey:p.compare(r,a),queryFn:()=>h(`/experiments/compare${v({tag_a:r,tag_b:a})}`),enabled:!!r&&!!a})}function ie(){const r=R();return D({mutationFn:a=>h("/experiments/tags",{method:"POST",body:JSON.stringify(a)}),onSuccess:()=>r.invalidateQueries({queryKey:p.tags})})}function ce(){const r=R();return D({mutationFn:a=>h(`/experiments/tags/${encodeURIComponent(a)}`,{method:"DELETE"}),onSuccess:()=>r.invalidateQueries({queryKey:p.tags})})}function le(r,a){return y({queryKey:p.compareMulti(r),queryFn:()=>h(`/experiments/compare-multi${v({tags:r.join(","),from:a.from,to:a.to})}`),enabled:r.length>=2})}function me(r,a){return y({queryKey:p.tagSessions(r),queryFn:()=>h(`/experiments/tags/${encodeURIComponent(r)}/sessions${v({from:a.from,to:a.to})}`),enabled:!!r})}function ue({onTagClick:r,expandedTag:a}){const{dateRange:c}=C(),{data:d,isLoading:i,error:t}=S(),n=ie(),u=ce(),[l,s]=m.useState(""),[x,f]=m.useState(""),[j,k]=m.useState(""),[b,w]=m.useState(""),{data:A}=I(c,"cost","desc",1,void 0),K=m.useCallback(()=>{if(!l.trim())return;const o={tag_name:l.trim(),...x&&{date_from:x},...j&&{date_to:j},...b&&{project_path:b}};n.mutate(o,{onSuccess:()=>{s(""),f(""),k(""),w("")}})},[l,x,j,b,n]);return i?e.jsx(N,{message:"Loading tags..."}):t?e.jsx(_,{message:t.message}):e.jsxs("div",{className:"rounded-lg border border-border bg-card p-4",children:[e.jsx("h3",{className:"text-sm font-medium text-muted-foreground mb-3",children:"Tags"}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-2 mb-4",children:[e.jsx("input",{type:"text",value:l,onChange:o=>s(o.target.value),placeholder:"Tag name...",className:"px-3 py-2 text-sm rounded-md border border-border bg-background focus:outline-none focus:ring-2 focus:ring-ring"}),e.jsx("input",{type:"date",value:x,onChange:o=>f(o.target.value),className:"px-3 py-2 text-sm rounded-md border border-border bg-background focus:outline-none focus:ring-2 focus:ring-ring"}),e.jsx("input",{type:"date",value:j,onChange:o=>k(o.target.value),className:"px-3 py-2 text-sm rounded-md border border-border bg-background focus:outline-none focus:ring-2 focus:ring-ring"}),e.jsxs("select",{value:b,onChange:o=>w(o.target.value),className:"px-3 py-2 text-sm rounded-md border border-border bg-background focus:outline-none focus:ring-2 focus:ring-ring",children:[e.jsx("option",{value:"",children:"All Projects"}),A?.projects.map(o=>e.jsx("option",{value:o.project_path,children:o.project_display},o.project_path))]}),e.jsxs("button",{onClick:K,disabled:!l.trim()||n.isPending,className:"flex items-center justify-center gap-1 px-3 py-2 text-sm rounded-md bg-primary text-primary-foreground hover:bg-primary/90 disabled:opacity-50",children:[e.jsx(U,{className:"h-4 w-4"}),"Create"]})]}),!d||d.tags.length===0?e.jsx(T,{message:"No experiment tags"}):e.jsx("div",{className:"space-y-1",children:d.tags.map(o=>e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between py-2 px-3 rounded hover:bg-accent/10",children:[e.jsxs("button",{onClick:()=>r(o.tag_name),className:"flex items-center gap-3 text-left",children:[a===o.tag_name?e.jsx(Y,{className:"h-3 w-3 text-muted-foreground"}):e.jsx(H,{className:"h-3 w-3 text-muted-foreground"}),e.jsx("span",{className:"font-medium text-sm",children:o.tag_name}),e.jsxs("span",{className:"text-xs text-muted-foreground",children:[o.session_count," sessions"]}),o.created_at&&e.jsx("span",{className:"text-xs text-muted-foreground",children:o.created_at})]}),e.jsx("button",{onClick:()=>u.mutate(o.tag_name),disabled:u.isPending,className:"p-1 rounded text-muted-foreground hover:text-destructive hover:bg-destructive/10",children:e.jsx(X,{className:"h-4 w-4"})})]}),a===o.tag_name&&e.jsx(xe,{tagName:o.tag_name})]},o.tag_name))})]})}function xe({tagName:r}){const{dateRange:a}=C(),{data:c,isLoading:d,error:i}=me(r,a);return d?e.jsx("div",{className:"px-6 py-2",children:e.jsx(N,{message:"Loading sessions..."})}):i?e.jsx("div",{className:"px-6 py-2",children:e.jsx(_,{message:i.message})}):!c||c.sessions.length===0?e.jsx("div",{className:"px-6 py-2",children:e.jsx(T,{message:"No sessions for this tag"})}):e.jsx("div",{className:"ml-6 mr-3 mb-2 rounded border border-border overflow-hidden",children:e.jsxs("table",{className:"w-full text-xs",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-muted/50 border-b border-border",children:[e.jsx("th",{className:"text-left px-3 py-1.5 font-medium text-muted-foreground",children:"Session"}),e.jsx("th",{className:"text-left px-3 py-1.5 font-medium text-muted-foreground",children:"Project"}),e.jsx("th",{className:"text-left px-3 py-1.5 font-medium text-muted-foreground",children:"Started"}),e.jsx("th",{className:"text-right px-3 py-1.5 font-medium text-muted-foreground",children:"Cost"}),e.jsx("th",{className:"text-right px-3 py-1.5 font-medium text-muted-foreground",children:"Turns"}),e.jsx("th",{className:"text-left px-3 py-1.5 font-medium text-muted-foreground",children:"Model"})]})}),e.jsx("tbody",{children:c.sessions.map(t=>e.jsxs("tr",{className:"border-b border-border hover:bg-accent/10",children:[e.jsx("td",{className:"px-3 py-1.5",children:e.jsxs(z,{to:`/sessions/${t.session_id}`,className:"font-mono text-primary hover:underline",children:[t.session_id.slice(0,8),"..."]})}),e.jsx("td",{className:"px-3 py-1.5 text-muted-foreground truncate max-w-[150px]",children:t.project_display}),e.jsx("td",{className:"px-3 py-1.5 text-muted-foreground",children:t.start_time?.slice(0,16)||"N/A"}),e.jsx("td",{className:"px-3 py-1.5 text-right font-mono",children:B(t.total_cost)}),e.jsx("td",{className:"px-3 py-1.5 text-right",children:t.turn_count}),e.jsx("td",{className:"px-3 py-1.5 text-muted-foreground",children:t.model_default})]},t.session_id))})]})})}function ge({tags:r,selectedTags:a,onToggle:c}){return e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"Select tags (up to 4):"}),r.map(d=>{const i=a.includes(d.tag_name),t=!i&&a.length>=4;return e.jsxs("button",{onClick:()=>c(d.tag_name),disabled:t,className:q("inline-flex items-center gap-1 px-2.5 py-1 rounded-full text-xs font-medium transition-colors",i?"bg-primary text-primary-foreground":"bg-muted text-muted-foreground hover:bg-accent hover:text-foreground",t&&"opacity-40 cursor-not-allowed"),children:[d.tag_name," (",d.session_count,")",i&&e.jsx(V,{className:"h-3 w-3"})]},d.tag_name)})]})}function pe({tags:r}){const a=["sessions","cost","loc","turns","error_rate"],c=m.useMemo(()=>a.map(t=>{const n={metric:t};for(const u of r)n[u.tag_name]=u[t];return n}),[r]),d=m.useMemo(()=>a.map(t=>{const n=r.map(s=>s[t]),u=Math.max(...n,.001),l={metric:t};for(const s of r)l[s.tag_name]=t==="error_rate"?(1-s[t])*100:s[t]/u*100;return l}),[r]),i={sessions:"Sessions",cost:"Cost ($)",loc:"LOC",turns:"Turns",error_rate:"Error Rate"};return e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"rounded-lg border border-border bg-card p-4",children:[e.jsx("h4",{className:"text-sm font-medium text-muted-foreground mb-3",children:"Metric Comparison"}),e.jsx("div",{className:"h-72",children:e.jsx(P,{width:"100%",height:"100%",children:e.jsxs(G,{data:c,margin:{top:4,right:8,left:0,bottom:4},children:[e.jsx(J,{dataKey:"metric",tick:{fontSize:10},stroke:"var(--color-muted-foreground)",tickFormatter:t=>i[t]||t}),e.jsx(W,{tick:{fontSize:10},stroke:"var(--color-muted-foreground)",width:55}),e.jsx(F,{contentStyle:L,formatter:(t,n)=>typeof t=="number"?[t<1?E(t):Q(t),n]:[t,n],labelFormatter:t=>i[t]||t}),e.jsx(M,{wrapperStyle:{fontSize:11}}),r.map((t,n)=>e.jsx(Z,{dataKey:t.tag_name,fill:g[n%g.length],radius:[4,4,0,0]},t.tag_name))]})})})]}),e.jsxs("div",{className:"rounded-lg border border-border bg-card p-4",children:[e.jsx("h4",{className:"text-sm font-medium text-muted-foreground mb-3",children:"Normalized Radar View"}),e.jsx("div",{className:"h-72",children:e.jsx(P,{width:"100%",height:"100%",children:e.jsxs(ee,{data:d,cx:"50%",cy:"50%",outerRadius:"70%",children:[e.jsx(te,{stroke:"var(--color-border)"}),e.jsx(se,{dataKey:"metric",tick:{fontSize:10,fill:"var(--color-muted-foreground)"},tickFormatter:t=>i[t]||t}),e.jsx(re,{tick:{fontSize:9},domain:[0,100]}),r.map((t,n)=>e.jsx(ae,{name:t.tag_name,dataKey:t.tag_name,stroke:g[n%g.length],fill:g[n%g.length],fillOpacity:.15},t.tag_name)),e.jsx(M,{wrapperStyle:{fontSize:11}}),e.jsx(F,{contentStyle:L,formatter:(t,n)=>[`${Number(t).toFixed(1)}%`,n]})]})})})]})]})}function he(){const{dateRange:r}=C(),{data:a}=S(),[c,d]=m.useState([]),{data:i,isLoading:t,error:n}=le(c,r),u=a?.tags||[],l=m.useCallback(s=>{d(x=>x.includes(s)?x.filter(f=>f!==s):x.length<4?[...x,s]:x)},[]);return e.jsxs("div",{className:"rounded-lg border border-border bg-card p-4",children:[e.jsx("h3",{className:"text-sm font-medium text-muted-foreground mb-3",children:"Multi-Tag Comparison"}),e.jsx("div",{className:"mb-4",children:e.jsx(ge,{tags:u,selectedTags:c,onToggle:l})}),c.length<2&&e.jsx("p",{className:"text-sm text-muted-foreground",children:"Select at least 2 tags to compare."}),t&&e.jsx(N,{message:"Comparing tags..."}),n&&e.jsx(_,{message:n.message}),i&&i.tags.length>=2&&e.jsx(pe,{tags:i.tags})]})}function fe(){const{data:r}=S(),[a,c]=m.useState(""),[d,i]=m.useState(""),{data:t,isLoading:n,error:u}=de(a,d),l=r?.tags||[];return e.jsxs("div",{className:"rounded-lg border border-border bg-card p-4",children:[e.jsx("h3",{className:"text-sm font-medium text-muted-foreground mb-3",children:"Compare Tags (A vs B)"}),e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsxs("select",{value:a,onChange:s=>c(s.target.value),className:"flex-1 px-3 py-2 text-sm rounded-md border border-border bg-background focus:outline-none focus:ring-2 focus:ring-ring",children:[e.jsx("option",{value:"",children:"Select Tag A..."}),l.map(s=>e.jsxs("option",{value:s.tag_name,children:[s.tag_name," (",s.session_count,")"]},s.tag_name))]}),e.jsx(ne,{className:"h-4 w-4 text-muted-foreground shrink-0"}),e.jsxs("select",{value:d,onChange:s=>i(s.target.value),className:"flex-1 px-3 py-2 text-sm rounded-md border border-border bg-background focus:outline-none focus:ring-2 focus:ring-ring",children:[e.jsx("option",{value:"",children:"Select Tag B..."}),l.map(s=>e.jsxs("option",{value:s.tag_name,children:[s.tag_name," (",s.session_count,")"]},s.tag_name))]})]}),n&&e.jsx(N,{message:"Comparing..."}),u&&e.jsx(_,{message:u.message}),t&&e.jsxs("div",{children:[e.jsxs("div",{className:"flex gap-4 mb-4 text-sm",children:[e.jsxs("span",{children:[e.jsx("strong",{children:t.tag_a}),": ",t.tag_a_sessions," sessions"]}),e.jsxs("span",{children:[e.jsx("strong",{children:t.tag_b}),": ",t.tag_b_sessions," sessions"]})]}),t.metrics.length===0?e.jsx(T,{message:"No metrics to compare"}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"border-b border-border",children:[e.jsx("th",{className:"text-left px-3 py-2 font-medium text-muted-foreground",children:"Metric"}),e.jsx("th",{className:"text-right px-3 py-2 font-medium text-muted-foreground",children:t.tag_a}),e.jsx("th",{className:"text-right px-3 py-2 font-medium text-muted-foreground",children:t.tag_b}),e.jsx("th",{className:"text-right px-3 py-2 font-medium text-muted-foreground",children:"Delta"}),e.jsx("th",{className:"text-right px-3 py-2 font-medium text-muted-foreground",children:"Change"})]})}),e.jsx("tbody",{children:t.metrics.map(s=>e.jsxs("tr",{className:"border-b border-border",children:[e.jsx("td",{className:"px-3 py-2",children:s.metric_name}),e.jsx("td",{className:"px-3 py-2 font-mono text-right",children:s.tag_a_value.toFixed(2)}),e.jsx("td",{className:"px-3 py-2 font-mono text-right",children:s.tag_b_value.toFixed(2)}),e.jsxs("td",{className:"px-3 py-2 font-mono text-right",children:[s.absolute_delta>=0?"+":"",s.absolute_delta.toFixed(2)]}),e.jsxs("td",{className:q("px-3 py-2 font-mono text-right",s.is_improvement?"text-green-500":"text-red-400"),children:[s.percentage_delta>=0?"+":"",E(s.percentage_delta/100)]})]},s.metric_name))})]})})]})]})}function Fe(){const[r,a]=m.useState(null),c=m.useCallback(d=>{a(i=>i===d?null:d)},[]);return e.jsx(O,{title:"Experiments",subtitle:"Tag sessions and compare outcomes",children:e.jsxs("div",{className:"space-y-6",children:[e.jsx(ue,{onTagClick:c,expandedTag:r}),e.jsx(he,{}),e.jsx(fe,{})]})})}export{Fe as default};
