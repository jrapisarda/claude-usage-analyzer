import{u as K,b as ue,c as pe,j as e}from"./query-vendor-ChV-W4bE.js";import{r as d,L as Ne}from"./react-vendor-yhu9f3WU.js";import{P as be}from"./PageLayout-D9m6_tUv.js";import{m as he,n as y,i as C,j as X,u as W,B,d as D,Z as ve,b as Z,X as Te,f as H,a as ge}from"./index-fSpeN2Hc.js";import{u as Se}from"./projects-Kb3ahsIL.js";import{E as q}from"./ErrorState-BLJWzcFK.js";import{E as je}from"./EmptyState-Ck70Pyw7.js";import{C as ce}from"./ChartContainer-CZHP22W9.js";import{D as ke}from"./DataTable-DaAT2w4Q.js";import{C as R,a as E,b as P,c as O}from"./card-Cst7U1OL.js";import{I as g}from"./input-B1u03xxg.js";import{B as I}from"./badge-35HJNii9.js";import{S as A}from"./skeleton-D4mSERnM.js";import{T as Me,a as we,b as z,c as N,d as Le,e as _}from"./table-ClnvA-zJ.js";import{S as Q,a as U,b as Y,c as G,d as F,C as Re}from"./select-DEp9fouH.js";import{T as le,C as f}from"./chartConfig-C_qPkli-.js";import{P as Ee,T as Pe}from"./trash-2-rBS5Mc5k.js";import{C as de}from"./chevron-down-CiMRQC6p.js";import{B as Oe,X as Ae,Y as Fe,T as me,L as xe,e as Ke,l as De,m as qe,n as $e,o as Be,p as Ie}from"./chart-vendor-CnSh9PGG.js";import"./index-CAqHlzL7.js";import"./check-C4JeTEY1.js";const ze=[["path",{d:"m16 3 4 4-4 4",key:"1x1c3m"}],["path",{d:"M20 7H4",key:"zbl0bi"}],["path",{d:"m8 21-4-4 4-4",key:"h9nckh"}],["path",{d:"M4 17h16",key:"g4d7ey"}]],Ve=he("arrow-right-left",ze);const He=[["rect",{width:"18",height:"11",x:"3",y:"11",rx:"2",ry:"2",key:"1w4ew1"}],["path",{d:"M7 11V7a5 5 0 0 1 10 0v4",key:"fwvmzm"}]],Qe=he("lock",He);function J(){return K({queryKey:y.tags,queryFn:()=>C("/experiments/tags")})}function Ue(t,r){return K({queryKey:y.compare(t,r),queryFn:()=>C(`/experiments/compare${X({tag_a:t,tag_b:r})}`),enabled:!!t&&!!r})}function Ye(){const t=ue();return pe({mutationFn:r=>C("/experiments/tags",{method:"POST",body:JSON.stringify(r)}),onSuccess:()=>t.invalidateQueries({queryKey:y.tags})})}function Ge(){const t=ue();return pe({mutationFn:r=>C(`/experiments/tags/${encodeURIComponent(r)}`,{method:"DELETE"}),onSuccess:()=>t.invalidateQueries({queryKey:y.tags})})}function Xe(t,r){return K({queryKey:y.compareMulti(t),queryFn:()=>C(`/experiments/compare-multi${X({tags:t.join(","),from:r.from,to:r.to})}`),enabled:t.length>=2})}function We(t,r){return K({queryKey:y.tagSessions(t),queryFn:()=>C(`/experiments/tags/${encodeURIComponent(t)}/sessions${X({from:r.from,to:r.to})}`),enabled:!!t})}const Ze=[{accessorKey:"session_id",header:"Session",cell:({row:t})=>e.jsxs(Ne,{to:`/sessions/${t.original.session_id}`,className:"font-mono text-xs text-primary hover:underline",children:[t.original.session_id.slice(0,8),"..."]})},{accessorKey:"project_display",header:"Project",cell:({row:t})=>e.jsx("span",{className:"text-muted-foreground truncate max-w-[150px] block text-xs",children:t.original.project_display})},{accessorKey:"start_time",header:"Started",cell:({row:t})=>e.jsx("span",{className:"text-muted-foreground text-xs",children:t.original.start_time?.slice(0,16)||"N/A"})},{accessorKey:"total_cost",header:()=>e.jsx("span",{className:"text-right block",children:"Cost"}),cell:({row:t})=>e.jsx("span",{className:"font-mono text-xs text-right block",children:ge(t.original.total_cost)})},{accessorKey:"turn_count",header:()=>e.jsx("span",{className:"text-right block",children:"Turns"}),cell:({row:t})=>e.jsx("span",{className:"text-xs text-right block",children:t.original.turn_count})},{accessorKey:"model_default",header:"Model",cell:({row:t})=>e.jsx("span",{className:"text-muted-foreground text-xs",children:t.original.model_default})}],L={cost:"Total Cost",cost_per_kloc:"Cost/KLOC",cache_hit_rate:"Cache Hit Rate",loc_written:"LOC Written",loc_delivered:"LOC Delivered",files_created:"Files Created",files_edited:"Files Edited",input_tokens:"Input Tokens",output_tokens:"Output Tokens",tokens_per_loc:"Tokens/LOC",thinking_chars:"Thinking Chars",sessions:"Sessions",user_turns:"User Turns",tool_calls:"Tool Calls",error_rate:"Error Rate",agent_spawns:"Agent Spawns"},_e={cost:"Cost & Efficiency",productivity:"Productivity",tokens:"Tokens",quality:"Quality & Workflow"},Je=["cost","productivity","tokens","quality"];function V(t,r){return t==="cost"||t==="cost_per_kloc"?ge(r):t==="error_rate"||t==="cache_hit_rate"?Z(r):t==="input_tokens"||t==="output_tokens"||t==="thinking_chars"?r>1e3?`${(r/1e3).toFixed(1)}K`:H(r):H(r)}function es({onTagClick:t,expandedTag:r}){const{dateRange:x}=W(),{data:i,isLoading:m,error:l,refetch:a}=J(),c=Ye(),h=Ge(),[p,u]=d.useState(""),[n,o]=d.useState(""),[j,ee]=d.useState(""),[b,se]=d.useState(""),[$,fe]=d.useState(!1),[v,te]=d.useState(""),[T,ae]=d.useState(""),[S,re]=d.useState(""),[k,ne]=d.useState(""),[M,oe]=d.useState(""),[w,ie]=d.useState(""),{data:ye}=Se(x,"cost","desc",1,void 0),Ce=d.useCallback(()=>{if(!p.trim())return;const s={tag_name:p.trim(),...n&&{date_from:n},...j&&{date_to:j},...b&&{project_path:b},...v&&{cc_version:v},...T&&{model:T},...S&&{min_cost:parseFloat(S)},...k&&{max_cost:parseFloat(k)},...M&&{min_loc:parseInt(M)},...w&&{max_loc:parseInt(w)}};c.mutate(s,{onSuccess:()=>{u(""),o(""),ee(""),se(""),te(""),ae(""),re(""),ne(""),oe(""),ie("")}})},[p,n,j,b,v,T,S,k,M,w,c]);return m?e.jsxs(R,{children:[e.jsx(E,{children:e.jsx(P,{className:"text-sm",children:"Tags"})}),e.jsxs(O,{children:[e.jsx(A,{className:"h-10 w-full mb-4"}),e.jsx(A,{className:"h-20 w-full"})]})]}):l?e.jsx(q,{message:l.message,onRetry:()=>a()}):e.jsxs(R,{children:[e.jsx(E,{children:e.jsx(P,{className:"text-sm",children:"Tags"})}),e.jsxs(O,{children:[e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-2 mb-2",children:[e.jsx(g,{type:"text",value:p,onChange:s=>u(s.target.value),placeholder:"Tag name..."}),e.jsx(g,{type:"date",value:n,onChange:s=>o(s.target.value)}),e.jsx(g,{type:"date",value:j,onChange:s=>ee(s.target.value)}),e.jsxs(Q,{value:b||"__all__",onValueChange:s=>se(s==="__all__"?"":s),children:[e.jsx(U,{children:e.jsx(Y,{placeholder:"All Projects"})}),e.jsxs(G,{children:[e.jsx(F,{value:"__all__",children:"All Projects"}),ye?.projects.map(s=>e.jsx(F,{value:s.project_path,children:s.project_display},s.project_path))]})]}),e.jsxs("div",{className:"flex gap-1",children:[e.jsxs(B,{onClick:Ce,disabled:!p.trim()||c.isPending,size:"sm",className:"h-9 flex-1",children:[e.jsx(Ee,{className:"mr-1 h-4 w-4"}),"Create"]}),e.jsx(B,{variant:"outline",size:"sm",className:"h-9 px-2",onClick:()=>fe(!$),title:"Advanced criteria",children:e.jsx(de,{className:D("h-4 w-4 transition-transform",$&&"rotate-180")})})]})]}),$&&e.jsxs("div",{className:"grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-2 mb-4 p-3 rounded-md bg-muted/30 border border-border/50",children:[e.jsx(g,{type:"text",value:v,onChange:s=>te(s.target.value),placeholder:"CC Version...",className:"text-xs"}),e.jsx(g,{type:"text",value:T,onChange:s=>ae(s.target.value),placeholder:"Model (e.g. opus)...",className:"text-xs"}),e.jsx(g,{type:"number",step:"0.01",value:S,onChange:s=>re(s.target.value),placeholder:"Min cost ($)...",className:"text-xs"}),e.jsx(g,{type:"number",step:"0.01",value:k,onChange:s=>ne(s.target.value),placeholder:"Max cost ($)...",className:"text-xs"}),e.jsx(g,{type:"number",value:M,onChange:s=>oe(s.target.value),placeholder:"Min LOC...",className:"text-xs"}),e.jsx(g,{type:"number",value:w,onChange:s=>ie(s.target.value),placeholder:"Max LOC...",className:"text-xs"})]}),!i||i.tags.length===0?e.jsx(je,{message:"No experiment tags"}):e.jsx("div",{className:"space-y-1",children:i.tags.map(s=>e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between py-2 px-3 rounded hover:bg-accent/10",children:[e.jsxs("button",{onClick:()=>t(s.tag_name),className:"flex flex-col gap-1 text-left",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[r===s.tag_name?e.jsx(Re,{className:"h-3 w-3 text-muted-foreground"}):e.jsx(de,{className:"h-3 w-3 text-muted-foreground"}),e.jsx("span",{className:"font-medium text-sm",children:s.tag_name}),e.jsxs(I,{variant:"secondary",children:[s.session_count," sessions"]}),s.is_smart?e.jsxs(I,{variant:"outline",className:"text-cyan-400 border-cyan-400/30 gap-1",children:[e.jsx(ve,{className:"h-3 w-3"}),"Smart"]}):e.jsxs(I,{variant:"outline",className:"text-muted-foreground gap-1",children:[e.jsx(Qe,{className:"h-3 w-3"}),"Static"]}),s.created_at&&e.jsx("span",{className:"text-xs text-muted-foreground",children:s.created_at})]}),s.is_smart&&s.criteria&&e.jsxs("div",{className:"flex flex-wrap gap-1.5 ml-6",children:[s.criteria.project_path&&e.jsxs("span",{className:"text-[10px] px-1.5 py-0.5 rounded bg-muted/50 text-muted-foreground",children:["Project: ",s.criteria.project_path.split(/[/\\]/).pop()]}),s.criteria.date_from&&e.jsxs("span",{className:"text-[10px] px-1.5 py-0.5 rounded bg-muted/50 text-muted-foreground",children:["From: ",s.criteria.date_from]}),s.criteria.date_to&&e.jsxs("span",{className:"text-[10px] px-1.5 py-0.5 rounded bg-muted/50 text-muted-foreground",children:["To: ",s.criteria.date_to]}),s.criteria.cc_version&&e.jsxs("span",{className:"text-[10px] px-1.5 py-0.5 rounded bg-muted/50 text-muted-foreground",children:["CC: ",s.criteria.cc_version]}),s.criteria.model&&e.jsxs("span",{className:"text-[10px] px-1.5 py-0.5 rounded bg-muted/50 text-muted-foreground",children:["Model: ",s.criteria.model]}),s.criteria.min_cost!=null&&e.jsxs("span",{className:"text-[10px] px-1.5 py-0.5 rounded bg-muted/50 text-muted-foreground",children:["Min $: ",s.criteria.min_cost]}),s.criteria.max_cost!=null&&e.jsxs("span",{className:"text-[10px] px-1.5 py-0.5 rounded bg-muted/50 text-muted-foreground",children:["Max $: ",s.criteria.max_cost]}),s.criteria.min_loc!=null&&e.jsxs("span",{className:"text-[10px] px-1.5 py-0.5 rounded bg-muted/50 text-muted-foreground",children:["Min LOC: ",s.criteria.min_loc]}),s.criteria.max_loc!=null&&e.jsxs("span",{className:"text-[10px] px-1.5 py-0.5 rounded bg-muted/50 text-muted-foreground",children:["Max LOC: ",s.criteria.max_loc]})]})]}),e.jsx(B,{variant:"ghost",size:"icon",onClick:()=>h.mutate(s.tag_name),disabled:h.isPending,className:"text-muted-foreground hover:text-destructive",children:e.jsx(Pe,{className:"h-4 w-4"})})]}),r===s.tag_name&&e.jsxs("div",{children:[s.is_smart&&s.criteria&&e.jsxs("div",{className:"ml-6 mr-3 mb-2 p-2 rounded bg-muted/20 text-xs text-muted-foreground flex flex-wrap gap-3",children:[s.criteria.date_from&&e.jsxs("span",{children:["From: ",s.criteria.date_from]}),s.criteria.date_to&&e.jsxs("span",{children:["To: ",s.criteria.date_to]}),s.criteria.project_path&&e.jsxs("span",{children:["Project: ",s.criteria.project_path]}),s.criteria.cc_version&&e.jsxs("span",{children:["CC: ",s.criteria.cc_version]}),s.criteria.model&&e.jsxs("span",{children:["Model: ",s.criteria.model]}),s.criteria.min_cost!=null&&e.jsxs("span",{children:["Min $: ",s.criteria.min_cost]}),s.criteria.max_cost!=null&&e.jsxs("span",{children:["Max $: ",s.criteria.max_cost]}),s.criteria.min_loc!=null&&e.jsxs("span",{children:["Min LOC: ",s.criteria.min_loc]}),s.criteria.max_loc!=null&&e.jsxs("span",{children:["Max LOC: ",s.criteria.max_loc]})]}),e.jsx(ss,{tagName:s.tag_name})]})]},s.tag_name))})]})]})}function ss({tagName:t}){const{dateRange:r}=W(),{data:x,isLoading:i,error:m,refetch:l}=We(t,r);if(m)return e.jsx("div",{className:"px-6 py-2",children:e.jsx(q,{message:m.message,onRetry:()=>l()})});const a=x?.sessions??[];return e.jsx("div",{className:"ml-6 mr-3 mb-2",children:e.jsx(ke,{columns:Ze,data:a,isLoading:i,emptyMessage:"No sessions for this tag"})})}function ts({tags:t,selectedTags:r,onToggle:x}){return e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"Select tags (up to 4):"}),t.map(i=>{const m=r.includes(i.tag_name),l=!m&&r.length>=4;return e.jsxs("button",{onClick:()=>x(i.tag_name),disabled:l,className:D("inline-flex items-center gap-1 px-2.5 py-1 rounded-full text-xs font-medium transition-colors",m?"bg-primary text-primary-foreground":"bg-muted text-muted-foreground hover:bg-accent hover:text-foreground",l&&"opacity-40 cursor-not-allowed"),children:[i.tag_name," (",i.session_count,")",m&&e.jsx(Te,{className:"h-3 w-3"})]},i.tag_name)})]})}const as={all:["sessions","cost","loc","turns","error_rate"],cost:["cost","cost_per_kloc","cache_hit_rate"],productivity:["loc","loc_delivered","files_created","files_edited"],tokens:["input_tokens","output_tokens","tokens_per_loc","thinking_chars"],quality:["sessions","turns","error_rate","agent_spawns"]};function rs({tags:t}){const[r,x]=d.useState("all"),i=as[r],m=d.useMemo(()=>i.map(a=>{const c={metric:a};for(const h of t)c[h.tag_name]=h[a];return c}),[t,i]),l=d.useMemo(()=>i.map(a=>{const c=t.map(u=>u[a]),h=Math.max(...c,.001),p={metric:a};for(const u of t)p[u.tag_name]=a==="error_rate"?(1-u[a])*100:u[a]/h*100;return p}),[t,i]);return e.jsxs("div",{children:[e.jsx("div",{className:"flex flex-wrap gap-1 mb-4",children:["all","cost","productivity","tokens","quality"].map(a=>e.jsx("button",{onClick:()=>x(a),className:D("px-3 py-1 rounded-full text-xs font-medium transition-colors",r===a?"bg-primary text-primary-foreground":"bg-muted text-muted-foreground hover:bg-accent"),children:a==="all"?"Overview":_e[a]||a},a))}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsx(ce,{title:"Metric Comparison",height:288,children:e.jsxs(Oe,{data:m,margin:{top:4,right:8,left:0,bottom:4},children:[e.jsx(Ae,{dataKey:"metric",tick:{fontSize:10},stroke:"var(--color-muted-foreground)",tickFormatter:a=>L[a]||a}),e.jsx(Fe,{tick:{fontSize:10},stroke:"var(--color-muted-foreground)",width:55}),e.jsx(me,{contentStyle:le,formatter:(a,c)=>typeof a=="number"?[a<1?Z(a):H(a),c]:[a,c],labelFormatter:a=>L[a]||a}),e.jsx(xe,{wrapperStyle:{fontSize:11}}),t.map((a,c)=>e.jsx(Ke,{dataKey:a.tag_name,fill:f[c%f.length],radius:[4,4,0,0]},a.tag_name))]})}),e.jsx(ce,{title:"Normalized Radar View",height:288,children:e.jsxs(De,{data:l,cx:"50%",cy:"50%",outerRadius:"70%",children:[e.jsx(qe,{stroke:"var(--color-border)"}),e.jsx($e,{dataKey:"metric",tick:{fontSize:10,fill:"var(--color-muted-foreground)"},tickFormatter:a=>L[a]||a}),e.jsx(Be,{tick:{fontSize:9},domain:[0,100]}),t.map((a,c)=>e.jsx(Ie,{name:a.tag_name,dataKey:a.tag_name,stroke:f[c%f.length],fill:f[c%f.length],fillOpacity:.15},a.tag_name)),e.jsx(xe,{wrapperStyle:{fontSize:11}}),e.jsx(me,{contentStyle:le,formatter:(a,c)=>[`${Number(a).toFixed(1)}%`,c]})]})})]})]})}function ns(){const{dateRange:t}=W(),{data:r}=J(),[x,i]=d.useState([]),{data:m,isLoading:l,error:a,refetch:c}=Xe(x,t),h=r?.tags||[],p=d.useCallback(u=>{i(n=>n.includes(u)?n.filter(o=>o!==u):n.length<4?[...n,u]:n)},[]);return e.jsxs(R,{children:[e.jsx(E,{children:e.jsx(P,{className:"text-sm",children:"Multi-Tag Comparison"})}),e.jsxs(O,{children:[e.jsx("div",{className:"mb-4",children:e.jsx(ts,{tags:h,selectedTags:x,onToggle:p})}),x.length<2&&e.jsx("p",{className:"text-sm text-muted-foreground",children:"Select at least 2 tags to compare."}),l&&e.jsx(A,{className:"h-64 w-full"}),a&&e.jsx(q,{message:a.message,onRetry:()=>c()}),m&&m.tags.length>=2&&e.jsx(rs,{tags:m.tags})]})]})}function os(){const{data:t}=J(),[r,x]=d.useState(""),[i,m]=d.useState(""),{data:l,isLoading:a,error:c,refetch:h}=Ue(r,i),p=t?.tags||[],u=d.useMemo(()=>{if(!l?.metrics)return[];const n={};for(const o of l.metrics){const j=o.category||"general";n[j]||(n[j]=[]),n[j].push(o)}return Je.filter(o=>n[o]?.length).map(o=>({category:o,label:_e[o]||o,metrics:n[o]}))},[l]);return e.jsxs(R,{children:[e.jsx(E,{children:e.jsx(P,{className:"text-sm",children:"Compare Tags (A vs B)"})}),e.jsxs(O,{children:[e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsxs(Q,{value:r||void 0,onValueChange:x,children:[e.jsx(U,{className:"flex-1",children:e.jsx(Y,{placeholder:"Select Tag A..."})}),e.jsx(G,{children:p.map(n=>e.jsxs(F,{value:n.tag_name,children:[n.tag_name," (",n.session_count,")"]},n.tag_name))})]}),e.jsx(Ve,{className:"h-4 w-4 text-muted-foreground shrink-0"}),e.jsxs(Q,{value:i||void 0,onValueChange:m,children:[e.jsx(U,{className:"flex-1",children:e.jsx(Y,{placeholder:"Select Tag B..."})}),e.jsx(G,{children:p.map(n=>e.jsxs(F,{value:n.tag_name,children:[n.tag_name," (",n.session_count,")"]},n.tag_name))})]})]}),a&&e.jsx(A,{className:"h-32 w-full"}),c&&e.jsx(q,{message:c.message,onRetry:()=>h()}),l&&e.jsxs("div",{children:[e.jsxs("div",{className:"flex gap-4 mb-4 text-sm",children:[e.jsxs("span",{children:[e.jsx("strong",{children:l.tag_a}),": ",l.tag_a_sessions," sessions"]}),e.jsxs("span",{children:[e.jsx("strong",{children:l.tag_b}),": ",l.tag_b_sessions," sessions"]})]}),u.length===0?e.jsx(je,{message:"No metrics to compare"}):e.jsx("div",{className:"rounded-md border border-border overflow-hidden",children:e.jsxs(Me,{children:[e.jsx(we,{children:e.jsxs(z,{children:[e.jsx(N,{children:"Metric"}),e.jsx(N,{className:"text-right",children:l.tag_a}),e.jsx(N,{className:"text-right",children:l.tag_b}),e.jsx(N,{className:"text-right",children:"Delta"}),e.jsx(N,{className:"text-right",children:"Change"})]})}),e.jsx(Le,{children:u.map(n=>e.jsxs(e.Fragment,{children:[e.jsx(z,{className:"bg-muted/30",children:e.jsx(_,{colSpan:5,className:"font-semibold text-xs text-muted-foreground uppercase tracking-wider py-1.5",children:n.label})},`cat-${n.category}`),n.metrics.map(o=>e.jsxs(z,{children:[e.jsx(_,{className:"text-sm",children:L[o.metric_name]||o.metric_name}),e.jsx(_,{className:"font-mono text-right text-sm",children:V(o.metric_name,o.tag_a_value)}),e.jsx(_,{className:"font-mono text-right text-sm",children:V(o.metric_name,o.tag_b_value)}),e.jsxs(_,{className:"font-mono text-right text-sm",children:[o.absolute_delta>=0?"+":"",V(o.metric_name,o.absolute_delta)]}),e.jsxs(_,{className:D("font-mono text-right text-sm",o.is_improvement?"text-green-500":"text-red-400"),children:[o.percentage_delta>=0?"+":"",Z(o.percentage_delta/100)]})]},o.metric_name))]}))})]})})]})]})]})}function Ms(){const[t,r]=d.useState(null),x=d.useCallback(i=>{r(m=>m===i?null:i)},[]);return e.jsx(be,{title:"Experiments",subtitle:"Tag sessions and compare outcomes",children:e.jsxs("div",{className:"space-y-6",children:[e.jsx(es,{onTagClick:x,expandedTag:t}),e.jsx(ns,{}),e.jsx(os,{})]})})}export{Ms as default};
