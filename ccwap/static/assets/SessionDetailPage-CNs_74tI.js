import{j as e}from"./query-vendor-ChV-W4bE.js";import{f as P,r as m}from"./react-vendor-yhu9f3WU.js";import{T as I,a as g,C as _}from"./chartConfig-C_qPkli-.js";import{f as l,a as p,c as A,d as R,B as $,X as z,e as H,g as C}from"./index-DOoA8ygH.js";import{d as F,B as X,X as Y,Y as G,T as W,L as U,e as b,P as V,f as q,C as J}from"./chart-vendor-Dwd1Lo9s.js";import{P as M}from"./PageLayout-DNcy9VzK.js";import{a as Q}from"./sessions-CaOAl1SQ.js";import{E as Z}from"./ErrorState-D6SGc0M3.js";import{M as O,a as h}from"./MetricCardGrid-DncIdQee.js";import{C as ee}from"./ChartContainer-BVfquKWB.js";import{E as se}from"./ExportDropdown-CT7rv4rS.js";import{C as N,c as v,a as T,b as S}from"./card-D1bak8k5.js";import{B as y}from"./badge-DX7wqLZ1.js";import{T as te,a as ae,b as L,c as B}from"./tabs-D_mtJQl8.js";import{S as E}from"./skeleton-4dVV08Mr.js";import"./index-yuhgJcXM.js";import"./index-B8TGfkCk.js";import"./check-DFm9GFPS.js";import"./download-CnbNskfO.js";function re({turns:t}){return t.length===0?e.jsx("p",{className:"text-sm text-muted-foreground",children:"No turn data available"}):e.jsx("div",{className:"h-72",children:e.jsx(F,{width:"100%",height:"100%",children:e.jsxs(X,{data:t,margin:{top:4,right:8,left:0,bottom:4},children:[e.jsx(Y,{dataKey:"turn_number",tick:{fontSize:10},stroke:"var(--color-muted-foreground)",label:{value:"Turn",position:"insideBottom",offset:-2,fontSize:11,fill:"var(--color-muted-foreground)"}}),e.jsx(G,{tick:{fontSize:10},stroke:"var(--color-muted-foreground)",tickFormatter:s=>l(s),width:55}),e.jsx(W,{contentStyle:I,formatter:(s,n)=>[l(s),n],labelFormatter:s=>`Turn ${s}`}),e.jsx(U,{wrapperStyle:{fontSize:11}}),e.jsx(b,{dataKey:"input_tokens",stackId:"tokens",fill:g.input,name:"Input"}),e.jsx(b,{dataKey:"output_tokens",stackId:"tokens",fill:g.output,name:"Output"}),e.jsx(b,{dataKey:"cache_read_tokens",stackId:"tokens",fill:g.cache_read,name:"Cache Read"}),e.jsx(b,{dataKey:"cache_write_tokens",stackId:"tokens",fill:g.cache_write,name:"Cache Write",radius:[4,4,0,0]})]})})})}const ne=24,le=200;function oe({turn:t,width:s,isSelected:n,onClick:i}){const o=t.tool_calls.some(c=>!c.success),x=t.stop_reason==="max_tokens",u=Math.min(t.cost*500,1);return e.jsxs("button",{onClick:i,className:R("h-16 shrink-0 rounded-sm transition-all relative group",n?"ring-2 ring-primary":"hover:ring-1 hover:ring-primary/50",o&&"border-2 border-red-500",x&&!o&&"border-2 border-yellow-500"),style:{width:`${s}px`,backgroundColor:`color-mix(in srgb, var(--color-chart-1) ${Math.round(u*100)}%, var(--color-muted) 30%)`},children:[e.jsxs("div",{className:"absolute bottom-full left-1/2 -translate-x-1/2 mb-1.5 px-2 py-1 rounded bg-popover border border-border text-popover-foreground text-[10px] whitespace-nowrap opacity-0 group-hover:opacity-100 pointer-events-none z-20 shadow-md",children:[t.entry_type," · ",p(t.cost)," · ",l(t.input_tokens+t.output_tokens)," tokens"]}),t.is_sidechain&&e.jsx("div",{className:"absolute top-0 right-0 w-2 h-2 rounded-full bg-purple-500"}),t.is_meta&&e.jsx("div",{className:"absolute top-0 left-0 w-2 h-2 rounded-full bg-cyan-500"}),e.jsx("span",{className:"absolute bottom-0.5 left-0 right-0 text-[9px] text-center opacity-0 group-hover:opacity-100 truncate px-0.5",children:p(t.cost)})]})}function ie({turns:t,blockWidths:s,containerWidth:n}){if(t.length<2)return null;const i=t[t.length-1].cumulative_cost||1,o=60,x=4;let u=0;const c=t.map((j,k)=>{const d=s[k],w=u+d/2;u+=d+x;const f=o-j.cumulative_cost/i*(o-4);return`${w},${f}`});return e.jsx("svg",{className:"absolute top-0 left-0 pointer-events-none",width:n,height:o,style:{overflow:"visible"},children:e.jsx("polyline",{points:c.join(" "),fill:"none",stroke:"var(--color-chart-2)",strokeWidth:1.5,strokeOpacity:.6})})}function ce({turn:t,onClose:s}){return e.jsxs("div",{className:"w-96 border-l border-border bg-card flex flex-col",children:[e.jsxs("div",{className:"flex items-center justify-between p-4 pb-2",children:[e.jsx("h3",{className:"font-medium",children:"Turn Detail"}),e.jsx($,{variant:"ghost",size:"icon",onClick:s,className:"h-7 w-7",children:e.jsx(z,{className:"h-4 w-4"})})]}),e.jsx(H,{className:"flex-1 px-4 pb-4",children:e.jsxs("div",{className:"space-y-3 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"Type"}),e.jsx("span",{children:t.entry_type})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"Model"}),e.jsx("span",{className:"font-mono",children:t.model||"N/A"})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"Cost"}),e.jsx("span",{className:"font-mono",children:p(t.cost)})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"Cumulative"}),e.jsx("span",{className:"font-mono",children:p(t.cumulative_cost)})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"Stop Reason"}),e.jsx("span",{children:t.stop_reason||"N/A"})]}),t.timestamp&&e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"Time"}),e.jsx("span",{children:new Date(t.timestamp).toLocaleTimeString()})]}),e.jsx(C,{}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-muted-foreground mb-2",children:"Tokens"}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"Input"}),e.jsx("span",{className:"font-mono",children:l(t.input_tokens)})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"Output"}),e.jsx("span",{className:"font-mono",children:l(t.output_tokens)})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"Cache Read"}),e.jsx("span",{className:"font-mono",children:l(t.cache_read_tokens)})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"Cache Write"}),e.jsx("span",{className:"font-mono",children:l(t.cache_write_tokens)})]})]})]}),t.thinking_chars>0&&e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"Thinking"}),e.jsxs("span",{className:"font-mono",children:[l(t.thinking_chars)," chars"]})]}),t.user_prompt_preview&&e.jsxs(e.Fragment,{children:[e.jsx(C,{}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-muted-foreground mb-2",children:"User Prompt"}),e.jsx("p",{className:"text-xs bg-muted/50 p-2 rounded whitespace-pre-wrap break-words",children:t.user_prompt_preview})]})]}),t.tool_calls.length>0&&e.jsxs(e.Fragment,{children:[e.jsx(C,{}),e.jsxs("div",{children:[e.jsxs("h4",{className:"font-medium text-muted-foreground mb-2",children:["Tool Calls (",t.tool_calls.length,")"]}),e.jsx("div",{className:"space-y-2",children:t.tool_calls.map((n,i)=>e.jsxs("div",{className:R("p-2 rounded text-xs",n.success?"bg-muted/50":"bg-red-500/10 border border-red-500/30"),children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"font-medium",children:n.tool_name}),!n.success&&e.jsx(y,{variant:"destructive",className:"text-[10px] px-1 py-0 h-4",children:"FAILED"})]}),n.file_path&&e.jsx("div",{className:"text-muted-foreground truncate mt-0.5",children:n.file_path}),n.loc_written>0&&e.jsxs("div",{className:"text-muted-foreground mt-0.5",children:["+",n.lines_added,"/-",n.lines_deleted," (",n.loc_written," LOC)"]}),n.error_message&&e.jsx("div",{className:"text-red-400 mt-1 break-words",children:n.error_message})]},i))})]})]}),e.jsxs("div",{className:"flex gap-1 mt-2",children:[t.is_sidechain&&e.jsx(y,{className:"bg-purple-500/20 text-purple-400 border-purple-500/30 text-xs",children:"sidechain"}),t.is_meta&&e.jsx(y,{className:"bg-cyan-500/20 text-cyan-400 border-cyan-500/30 text-xs",children:"meta"})]})]})})]})}function De(){const{id:t}=P(),{data:s,isLoading:n,error:i}=Q(t),[o,x]=m.useState(null),u=m.useRef(null),c=m.useMemo(()=>{if(!s)return[];const a=Math.max(...s.turns.map(r=>r.input_tokens+r.output_tokens),1);return s.turns.map(r=>{const K=(r.input_tokens+r.output_tokens)/a;return Math.max(ne,Math.round(K*le))})},[s]),j=m.useMemo(()=>c.reduce((r,D)=>r+D+4,0)-4,[c]),k=m.useMemo(()=>s?s.turns.map((a,r)=>({turn_number:r+1,input_tokens:a.input_tokens,output_tokens:a.output_tokens,cache_read_tokens:a.cache_read_tokens,cache_write_tokens:a.cache_write_tokens})):[],[s]),d=m.useMemo(()=>s?.tool_distribution?Object.entries(s.tool_distribution).sort((a,r)=>r[1]-a[1]).slice(0,10).map(([a,r])=>({name:a,value:r})):[],[s]),w=m.useCallback(a=>{x(r=>r===a?null:a)},[]);if(n)return e.jsxs(M,{title:"Session Detail",subtitle:"Turn-by-turn session replay",breadcrumbs:[{label:"Sessions",href:"/sessions"},{label:"..."}],children:[e.jsx(O,{skeleton:!0,count:5,className:"grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 mb-6"}),e.jsx(E,{className:"h-32 w-full mb-6"}),e.jsx(E,{className:"h-64 w-full"})]});if(i)return e.jsx(Z,{message:i.message});if(!s)return null;const f=o!==null?s.turns[o]:null;return e.jsxs(M,{title:"Session Detail",subtitle:"Turn-by-turn session replay",breadcrumbs:[{label:"Sessions",href:"/sessions"},{label:t?.slice(0,12)??""}],actions:e.jsx(se,{page:`session-${t}`,getData:()=>(s?.turns||[]).map((a,r)=>({turn:r+1,entry_type:a.entry_type,model:a.model,input_tokens:a.input_tokens,output_tokens:a.output_tokens,cost:a.cost,cumulative_cost:a.cumulative_cost,stop_reason:a.stop_reason||"",is_sidechain:a.is_sidechain,user_prompt_preview:a.user_prompt_preview||""})),columns:["turn","entry_type","model","input_tokens","output_tokens","cost","cumulative_cost","stop_reason","is_sidechain","user_prompt_preview"]}),children:[e.jsx(N,{className:"mb-6",children:e.jsxs(v,{className:"pt-4 pb-4",children:[e.jsxs("div",{className:"flex flex-wrap items-center gap-x-4 gap-y-1 text-sm",children:[e.jsx("span",{className:"font-medium text-lg",children:s.project_display||s.project_path}),s.is_agent&&e.jsx(y,{className:"bg-purple-500/20 text-purple-400 border-purple-500/30",children:"agent"}),s.cc_version&&e.jsxs("span",{className:"text-muted-foreground",children:["v",s.cc_version]}),s.git_branch&&e.jsx("span",{className:"text-muted-foreground font-mono",children:s.git_branch})]}),e.jsxs("div",{className:"flex flex-wrap gap-4 mt-2 text-xs text-muted-foreground",children:[s.first_timestamp&&e.jsx("span",{children:new Date(s.first_timestamp).toLocaleString()}),e.jsxs("span",{className:"font-mono",children:[s.session_id.slice(0,12),"..."]})]})]})}),e.jsxs(O,{className:"grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 mb-6",children:[e.jsx(h,{title:"Cost",value:p(s.total_cost)}),e.jsx(h,{title:"Duration",value:A(s.duration_seconds)}),e.jsx(h,{title:"Turns",value:l(s.total_turns),subtitle:`${s.total_user_turns} user`}),e.jsx(h,{title:"Tool Calls",value:l(s.total_tool_calls)}),e.jsx(h,{title:"Errors",value:l(s.total_errors),className:s.total_errors>0?"border-amber-500/50 bg-amber-500/10":void 0})]}),e.jsxs("div",{className:"flex gap-6",children:[e.jsxs("div",{className:"flex-1 min-w-0 space-y-6",children:[e.jsxs(N,{children:[e.jsx(T,{className:"pb-3 pt-4 px-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(S,{className:"text-sm font-medium text-muted-foreground",children:"Timeline"}),e.jsxs("div",{className:"flex gap-3 text-[10px] text-muted-foreground",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx("span",{className:"w-2 h-2 rounded-full bg-red-500"})," Error"]}),e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx("span",{className:"w-2 h-2 rounded-full bg-yellow-500"})," Truncation"]}),e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx("span",{className:"w-2 h-2 rounded-full bg-purple-500"})," Sidechain"]}),e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx("span",{className:"w-2 h-2 rounded-full bg-cyan-500"})," Meta"]})]})]})}),e.jsx(v,{className:"px-4 pb-4",children:e.jsx("div",{ref:u,className:"overflow-x-auto relative",style:{minHeight:"80px"},children:e.jsxs("div",{className:"relative",style:{width:`${j}px`,minWidth:"100%"},children:[e.jsx(ie,{turns:s.turns,blockWidths:c,containerWidth:j}),e.jsx("div",{className:"flex gap-1 relative z-10",children:s.turns.map((a,r)=>e.jsx(oe,{turn:a,width:c[r],isSelected:o===r,onClick:()=>w(r)},a.uuid))})]})})})]}),e.jsxs(te,{defaultValue:"cost",children:[e.jsxs(ae,{children:[e.jsx(L,{value:"cost",children:"Cost Breakdown"}),e.jsx(L,{value:"tokens",children:"Token Waterfall"})]}),e.jsxs(B,{value:"cost",children:[e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[Object.keys(s.cost_by_model).length>0&&e.jsxs(N,{children:[e.jsx(T,{className:"pb-3 pt-4 px-4",children:e.jsx(S,{className:"text-sm font-medium text-muted-foreground",children:"Cost by Model"})}),e.jsx(v,{className:"px-4 pb-4",children:e.jsx("div",{className:"space-y-2",children:Object.entries(s.cost_by_model).sort((a,r)=>r[1]-a[1]).map(([a,r])=>e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"truncate font-mono",children:a}),e.jsx("span",{className:"font-mono shrink-0 ml-2",children:p(r)})]},a))})})]}),e.jsx(ee,{title:"Tool Distribution",height:192,isEmpty:d.length===0,emptyMessage:"No tool data",children:e.jsxs(V,{children:[e.jsx(q,{data:d,dataKey:"value",nameKey:"name",cx:"50%",cy:"50%",outerRadius:70,strokeWidth:0,children:d.map((a,r)=>e.jsx(J,{fill:_[r%_.length]},r))}),e.jsx(W,{contentStyle:I})]})})]}),d.length>0&&e.jsx("div",{className:"flex flex-wrap gap-2 mt-2",children:d.map((a,r)=>e.jsxs("span",{className:"text-[10px] flex items-center gap-1",children:[e.jsx("span",{className:"w-2 h-2 rounded-full",style:{backgroundColor:_[r%_.length]}}),a.name," (",a.value,")"]},a.name))})]}),e.jsx(B,{value:"tokens",children:e.jsxs(N,{children:[e.jsx(T,{className:"pb-3 pt-4 px-4",children:e.jsx(S,{className:"text-sm font-medium text-muted-foreground",children:"Token Breakdown per Turn"})}),e.jsx(v,{className:"px-4 pb-4",children:e.jsx(re,{turns:k})})]})})]})]}),f&&e.jsx(ce,{turn:f,onClose:()=>x(null)})]})]})}export{De as default};
